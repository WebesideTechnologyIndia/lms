{% extends 'base.html' %}

{% block title %}Quick Payment - {{ assignment.student.get_full_name }} - LMS Admin{% endblock %}

{% block content %}
<!-- Breadcrumb -->
<nav aria-label="breadcrumb" class="mb-4">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{% url 'admin_dashboard' %}">Dashboard</a></li>
        <li class="breadcrumb-item"><a href="{% url 'fees:admin_fees_dashboard' %}">Fees</a></li>
        <li class="breadcrumb-item"><a href="{% url 'fees:manage_student_fees' %}">Student Fees</a></li>
        <li class="breadcrumb-item"><a href="{% url 'fees:student_fee_detail' assignment.id %}">{{
                assignment.student.get_full_name }}</a></li>
        <li class="breadcrumb-item active">Quick Payment</li>
    </ol>
</nav>

<!-- Page Header -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2 class="mb-1">
            <i class="fas fa-credit-card me-2 text-success"></i>Quick Payment
        </h2>
        <p class="text-muted mb-0">Record payment for {{ assignment.student.get_full_name }}</p>
    </div>
    <div class="d-flex gap-2">
        <a href="{% url 'fees:student_fee_detail' assignment.id %}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-2"></i>Back to Details
        </a>
        <a href="{% url 'fees:record_payment' %}?student={{ assignment.student.id }}" class="btn btn-outline-primary">
            <i class="fas fa-plus me-2"></i>Full Payment Form
        </a>
    </div>
</div>

<!-- Student & Course Info Card -->
<div class="card shadow-sm mb-4">
    <div class="card-header bg-primary text-white">
        <h5 class="mb-0">
            <i class="fas fa-info-circle me-2"></i>Payment Information
        </h5>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <h6 class="text-muted mb-2">Student Details</h6>
                <div class="d-flex align-items-center mb-3">
                    <div class="flex-shrink-0">
                        <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center"
                            style="width: 50px; height: 50px;">
                            <i class="fas fa-user text-white"></i>
                        </div>
                    </div>
                    <div class="flex-grow-1 ms-3">
                        <h5 class="mb-0">{{ assignment.student.get_full_name }}</h5>
                        <small class="text-muted">{{ assignment.student.email }}</small>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <h6 class="text-muted mb-2">Course Details</h6>
                <div class="d-flex align-items-center mb-3">
                    <div class="flex-shrink-0">
                        <div class="bg-info rounded-circle d-flex align-items-center justify-content-center"
                            style="width: 50px; height: 50px;">
                            <i class="fas fa-book text-white"></i>
                        </div>
                    </div>
                    <div class="flex-grow-1 ms-3">
                        <h5 class="mb-0">{{ assignment.course.title }}</h5>
                        <small class="text-muted">{{ assignment.course.course_code }}</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Payment Summary -->
        <div class="row mt-3">
            <div class="col-md-3">
                <div class="text-center p-3 bg-light rounded">
                    <h6 class="text-muted mb-1">Total Fee</h6>
                    <h4 class="mb-0 text-primary">₹{{ assignment.total_amount|floatformat:2 }}</h4>
                </div>
            </div>
            <div class="col-md-3">
                <div class="text-center p-3 bg-light rounded">
                    <h6 class="text-muted mb-1">Amount Paid</h6>
                    <h4 class="mb-0 text-success">₹{{ assignment.amount_paid|floatformat:2 }}</h4>
                </div>
            </div>
            <div class="col-md-3">
                <div class="text-center p-3 bg-light rounded">
                    <h6 class="text-muted mb-1">Amount Pending</h6>
                    <h4 class="mb-0 text-warning">₹{{ assignment.amount_pending|floatformat:2 }}</h4>
                </div>
            </div>
            <div class="col-md-3">
                <div class="text-center p-3 bg-light rounded">
                    <h6 class="text-muted mb-1">Course Status</h6>
                    {% if assignment.is_course_locked %}
                    <span class="badge bg-danger fs-6">
                        <i class="fas fa-lock me-1"></i>Locked
                    </span>
                    {% else %}
                    <span class="badge bg-success fs-6">
                        <i class="fas fa-unlock me-1"></i>Active
                    </span>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Quick Payment Form -->
<div class="card shadow">
    <div class="card-header bg-success text-white">
        <h5 class="mb-0">
            <i class="fas fa-money-bill-wave me-2"></i>Record Payment
        </h5>
    </div>
    <div class="card-body">
        <form method="post" id="quickPaymentForm">
            {% csrf_token %}

            <!-- Payment Type Selection -->
            <div class="row mb-4">
                <div class="col-12">
                    <h6 class="mb-3">
                        <i class="fas fa-calculator me-2"></i>Select Payment Type
                    </h6>
                    <div class="row">
                        <div class="col-md-3">
                            <div class="card payment-option" data-type="current_emi" data-amount="0">
                                <div class="card-body text-center">
                                    <i class="fas fa-calendar-check fa-2x text-primary mb-2"></i>
                                    <h6>Current EMI</h6>
                                    <p class="text-muted small mb-2">Pay next due EMI</p>
                                    <div class="amount-display">
                                        <strong class="text-primary">₹<span id="current-emi-amount">0.00</span></strong>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card payment-option" data-type="overdue_emis" data-amount="0">
                                <div class="card-body text-center">
                                    <i class="fas fa-exclamation-triangle fa-2x text-warning mb-2"></i>
                                    <h6>Overdue EMIs</h6>
                                    <p class="text-muted small mb-2">Pay all overdue amounts</p>
                                    <div class="amount-display">
                                        <strong class="text-warning">₹<span id="overdue-emi-amount">0.00</span></strong>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card payment-option" data-type="full_course"
                                data-amount="{{ assignment.amount_pending }}">
                                <div class="card-body text-center">
                                    <i class="fas fa-check-circle fa-2x text-success mb-2"></i>
                                    <h6>Full Payment</h6>
                                    <p class="text-muted small mb-2">Pay complete pending amount</p>
                                    <div class="amount-display">
                                        <strong class="text-success">₹{{ assignment.amount_pending|floatformat:2
                                            }}</strong>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card payment-option" data-type="custom" data-amount="0">
                                <div class="card-body text-center">
                                    <i class="fas fa-edit fa-2x text-info mb-2"></i>
                                    <h6>Custom Amount</h6>
                                    <p class="text-muted small mb-2">Enter custom amount</p>
                                    <div class="amount-display">
                                        <strong class="text-info">Custom</strong>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Payment Form Fields -->
            <div class="row">
                <div class="col-md-6">
                    <!-- Amount -->
                    <div class="mb-3">
                        <label for="amount" class="form-label">Payment Amount <span class="text-danger">*</span></label>
                        <div class="input-group">
                            <span class="input-group-text">₹</span>
                            <input type="number" class="form-control" id="amount" name="amount" step="0.01" min="0.01"
                                required readonly>
                        </div>
                        <div class="form-text">Amount will be auto-filled based on payment type selection</div>
                    </div>

                    <!-- Custom Amount (Hidden by default) -->
                    <div class="mb-3" id="custom-amount-field" style="display: none;">
                        <label for="custom_amount" class="form-label">Custom Amount <span
                                class="text-danger">*</span></label>
                        <div class="input-group">
                            <span class="input-group-text">₹</span>
                            <input type="number" class="form-control" id="custom_amount" name="custom_amount"
                                step="0.01" min="0.01">
                        </div>
                    </div>

                    <!-- Payment Method -->
                    <div class="mb-3">
                        <label for="payment_method" class="form-label">Payment Method <span
                                class="text-danger">*</span></label>
                        <select class="form-select" id="payment_method" name="payment_method" required>
                            <option value="">Select payment method</option>
                            <option value="cash">Cash</option>
                            <option value="online">Online Payment</option>
                            <option value="card">Card Payment</option>
                            <option value="upi">UPI</option>
                            <option value="bank_transfer">Bank Transfer</option>
                            <option value="cheque">Cheque</option>
                        </select>
                    </div>

                    <!-- Payment Date -->
                    <div class="mb-3">
                        <label for="payment_date" class="form-label">Payment Date <span
                                class="text-danger">*</span></label>
                        <input type="date" class="form-control" id="payment_date" name="payment_date"
                            value="{{ today|date:'Y-m-d' }}" required>
                    </div>
                </div>

                <div class="col-md-6">
                    <!-- Transaction ID -->
                    <div class="mb-3">
                        <label for="transaction_id" class="form-label">Transaction ID</label>
                        <input type="text" class="form-control" id="transaction_id" name="transaction_id"
                            placeholder="Transaction ID (for online payments)">
                        <div class="form-text">Required for online payments</div>
                    </div>

                    <!-- Reference Number -->
                    <div class="mb-3">
                        <label for="reference_number" class="form-label">Reference Number</label>
                        <input type="text" class="form-control" id="reference_number" name="reference_number"
                            placeholder="Reference number">
                    </div>

                    <!-- Bank Details (Hidden by default) -->
                    <div class="mb-3" id="bank-fields" style="display: none;">
                        <label for="bank_name" class="form-label">Bank Name</label>
                        <input type="text" class="form-control" id="bank_name" name="bank_name" placeholder="Bank name">
                    </div>

                    <div class="mb-3" id="cheque-fields" style="display: none;">
                        <label for="cheque_number" class="form-label">Cheque Number</label>
                        <input type="text" class="form-control" id="cheque_number" name="cheque_number"
                            placeholder="Cheque number">
                    </div>

                    <!-- Notes -->
                    <div class="mb-3">
                        <label for="notes" class="form-label">Payment Notes</label>
                        <textarea class="form-control" id="notes" name="notes" rows="3"
                            placeholder="Additional notes about this payment..."></textarea>
                    </div>
                </div>
            </div>

            <!-- Hidden Fields -->
            <input type="hidden" id="payment_type" name="payment_type" value="">
            <input type="hidden" name="fee_assignment" value="{{ assignment.id }}">

            <!-- Submit Buttons -->
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <small class="text-muted">
                        <i class="fas fa-info-circle me-1"></i>
                        All fields marked with <span class="text-danger">*</span> are required
                    </small>
                </div>
                <div class="d-flex gap-2">
                    <a href="{% url 'fees:student_fee_detail' assignment.id %}" class="btn btn-secondary">
                        <i class="fas fa-times me-2"></i>Cancel
                    </a>
                    <button type="submit" class="btn btn-success" id="submit-btn" disabled>
                        <i class="fas fa-save me-2"></i>Record Payment
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

{% endblock %}

{% block extra_css %}
<style>
    .payment-option {
        cursor: pointer;
        transition: all 0.2s ease;
        border: 2px solid transparent;
    }

    .payment-option:hover {
        border-color: #0d6efd;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .payment-option.selected {
        border-color: #198754;
        background-color: #f8f9fa;
    }

    .payment-option.selected .card-body {
        background-color: rgba(25, 135, 84, 0.1);
    }

    .amount-display {
        min-height: 24px;
        margin-top: 8px;
    }

    .stats-card {
        border: none;
        border-radius: 0.5rem;
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
     let selectedPaymentType = null;
    let paymentAmounts = {
        'current_emi': 0,
        'overdue_emis': 0,
        'full_course': {{ assignment.amount_pending|floatformat:2 }},
        'custom': 0
    };

    document.addEventListener('DOMContentLoaded', function () {
        // Load payment amounts from server
        loadPaymentAmounts();

        // Setup payment option selection
        setupPaymentOptions();

        // Setup payment method change handler
        setupPaymentMethodHandler();

        // Setup form validation
        setupFormValidation();
    });

    function loadPaymentAmounts() {
        // Load current EMI amount
        fetch(`/fees/ajax/calculate-payment/?assignment_id={{ assignment.id }}&payment_type=current_emi`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    paymentAmounts.current_emi = data.amount;
                    document.getElementById('current-emi-amount').textContent = data.amount.toFixed(2);
                    document.querySelector('[data-type="current_emi"]').setAttribute('data-amount', data.amount);
                }
            });

        // Load overdue EMIs amount
        fetch(`/fees/ajax/calculate-payment/?assignment_id={{ assignment.id }}&payment_type=overdue_emis`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    paymentAmounts.overdue_emis = data.amount;
                    document.getElementById('overdue-emi-amount').textContent = data.amount.toFixed(2);
                    document.querySelector('[data-type="overdue_emis"]').setAttribute('data-amount', data.amount);
                }
            });
    }

    function setupPaymentOptions() {
        const paymentOptions = document.querySelectorAll('.payment-option');

        paymentOptions.forEach(option => {
            option.addEventListener('click', function () {
                // Remove previous selection
                paymentOptions.forEach(opt => opt.classList.remove('selected'));

                // Add selection to clicked option
                this.classList.add('selected');

                // Get payment type and amount
                const paymentType = this.getAttribute('data-type');
                const amount = parseFloat(this.getAttribute('data-amount'));

                selectedPaymentType = paymentType;

                // Update form
                updatePaymentForm(paymentType, amount);
            });
        });
    }

    function updatePaymentForm(paymentType, amount) {
        const amountField = document.getElementById('amount');
        const customAmountField = document.getElementById('custom-amount-field');
        const paymentTypeField = document.getElementById('payment_type');

        paymentTypeField.value = paymentType;

        if (paymentType === 'custom') {
            // Show custom amount field
            customAmountField.style.display = 'block';
            amountField.value = '';
            amountField.readOnly = true;

            // Focus on custom amount field
            document.getElementById('custom_amount').focus();

            // Update amount when custom amount changes
            document.getElementById('custom_amount').addEventListener('input', function () {
                amountField.value = this.value;
                validateForm();
            });
        } else {
            // Hide custom amount field and set amount
            customAmountField.style.display = 'none';
            amountField.value = amount.toFixed(2);
            amountField.readOnly = true;
        }

        validateForm();
    }

    function setupPaymentMethodHandler() {
        const paymentMethodField = document.getElementById('payment_method');
        const bankFields = document.getElementById('bank-fields');
        const chequeFields = document.getElementById('cheque-fields');
        const transactionField = document.getElementById('transaction_id');

        paymentMethodField.addEventListener('change', function () {
            const method = this.value;

            // Hide all conditional fields first
            bankFields.style.display = 'none';
            chequeFields.style.display = 'none';
            transactionField.required = false;

            // Show relevant fields based on payment method
            if (method === 'bank_transfer' || method === 'cheque') {
                bankFields.style.display = 'block';
            }

            if (method === 'cheque') {
                chequeFields.style.display = 'block';
            }

            if (method === 'online' || method === 'card' || method === 'upi') {
                transactionField.required = true;
            }

            validateForm();
        });
    }

    function setupFormValidation() {
        const form = document.getElementById('quickPaymentForm');
        const requiredFields = form.querySelectorAll('[required]');

        requiredFields.forEach(field => {
            field.addEventListener('input', validateForm);
            field.addEventListener('change', validateForm);
        });
    }

    function validateForm() {
        const form = document.getElementById('quickPaymentForm');
        const submitBtn = document.getElementById('submit-btn');
        const amount = document.getElementById('amount').value;
        const paymentMethod = document.getElementById('payment_method').value;
        const paymentDate = document.getElementById('payment_date').value;

        let isValid = true;

        // Check if payment type is selected
        if (!selectedPaymentType) {
            isValid = false;
        }

        // Check amount
        if (!amount || parseFloat(amount) <= 0) {
            isValid = false;
        }

        // Check payment method
        if (!paymentMethod) {
            isValid = false;
        }

        // Check payment date
        if (!paymentDate) {
            isValid = false;
        }

        // Check transaction ID for online payments
        const transactionField = document.getElementById('transaction_id');
        if (transactionField.required && !transactionField.value) {
            isValid = false;
        }

        // For custom payment, check custom amount
        if (selectedPaymentType === 'custom') {
            const customAmount = document.getElementById('custom_amount').value;
            if (!customAmount || parseFloat(customAmount) <= 0) {
                isValid = false;
            }
        }

        submitBtn.disabled = !isValid;
    }

    // Form submission handler
    document.getElementById('quickPaymentForm').addEventListener('submit', function (e) {
        if (!selectedPaymentType) {
            e.preventDefault();
            alert('Please select a payment type.');
            return;
        }

        // Show loading state
        const submitBtn = document.getElementById('submit-btn');
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Processing...';
        submitBtn.disabled = true;
    });
</script>
{% endblock %}