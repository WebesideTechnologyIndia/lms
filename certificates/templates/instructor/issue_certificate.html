{% extends 'base.html' %}
{% load static %}

{% block title %}Issue Certificate - Admin Panel{% endblock %}

{% block extra_css %}
<style>
.page-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 30px;
    border-radius: 15px;
    margin-bottom: 30px;
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
}

.form-card {
    background: white;
    border-radius: 15px;
    padding: 30px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.08);
    margin-bottom: 20px;
}

.template-card {
    border: 2px solid #e9ecef;
    border-radius: 10px;
    padding: 15px;
    cursor: pointer;
    transition: all 0.3s;
    display: block;
}

.template-card:hover {
    border-color: #667eea;
    background: #f8f9ff;
}

.template-card.selected {
    border-color: #667eea;
    background: #e7f3ff;
}

.student-item {
    padding: 12px;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    margin-bottom: 10px;
    cursor: pointer;
    transition: all 0.2s;
}

.student-item:hover {
    background: #f8f9fa;
}

.student-item.selected {
    background: #e7f3ff;
    border-color: #667eea;
}

/* Modal Styles */
.context-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    z-index: 99999;
    justify-content: center;
    align-items: center;
}

.context-modal.show {
    display: flex !important;
}

.modal-content-box {
    background: white;
    padding: 40px;
    border-radius: 20px;
    max-width: 700px;
    width: 90%;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 20px 60px rgba(0,0,0,0.5);
    animation: modalSlideIn 0.3s ease;
}

@keyframes modalSlideIn {
    from {
        transform: translateY(-50px);
        opacity: 0;
    }
    to {
        transform: translateY(0);
        opacity: 1;
    }
}

.modal-header {
    text-align: center;
    margin-bottom: 30px;
}

.modal-title {
    font-size: 1.8rem;
    color: #2d3748;
    margin-bottom: 10px;
}

.modal-subtitle {
    color: #6b7280;
    font-size: 1rem;
}

.context-option {
    border: 3px solid #e9ecef;
    border-radius: 15px;
    padding: 25px;
    margin: 15px 0;
    cursor: pointer;
    transition: all 0.3s;
    position: relative;
}

.context-option:hover {
    border-color: #667eea;
    background: #f8f9ff;
    transform: translateY(-3px);
    box-shadow: 0 5px 20px rgba(102, 126, 234, 0.2);
}

.context-option.active {
    border-color: #667eea;
    background: linear-gradient(135deg, #e7f3ff 0%, #f0f4ff 100%);
    box-shadow: 0 5px 20px rgba(102, 126, 234, 0.3);
}

.context-option input[type="radio"] {
    position: absolute;
    top: 20px;
    right: 20px;
    width: 24px;
    height: 24px;
    cursor: pointer;
}

.context-icon {
    width: 70px;
    height: 70px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 15px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 2rem;
    margin-bottom: 15px;
}

.context-title {
    font-size: 1.4rem;
    font-weight: 700;
    color: #2d3748;
    margin-bottom: 10px;
}

.context-desc {
    color: #6b7280;
    line-height: 1.6;
    margin-bottom: 10px;
}

.context-for {
    background: #667eea;
    color: white;
    padding: 8px 15px;
    border-radius: 20px;
    font-size: 0.9rem;
    font-weight: 600;
    display: inline-block;
    margin-top: 10px;
}

.modal-actions {
    display: flex;
    gap: 15px;
    margin-top: 30px;
}

.modal-actions button {
    flex: 1;
    padding: 15px;
    font-size: 1.1rem;
    font-weight: 600;
    border-radius: 10px;
    border: none;
    cursor: pointer;
    transition: all 0.3s;
}

.btn-confirm {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.btn-confirm:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
}

.btn-cancel {
    background: #e9ecef;
    color: #4a5568;
}

.btn-cancel:hover {
    background: #d1d5db;
}

.recipient-section {
    display: none;
}

.recipient-section.active {
    display: block;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    
    <!-- Page Header -->
    <div class="page-header">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="mb-2">
                    <i class="bi bi-award me-3"></i>Issue Certificates
                </h1>
                <p class="mb-0 opacity-75">Award certificates with proper context selection</p>
            </div>
            <div>
                <a href="{% url 'certificates:admin_dashboard' %}" class="btn btn-light btn-lg">
                    <i class="bi bi-arrow-left me-2"></i>Back
                </a>
            </div>
        </div>
    </div>

    <form method="post" id="issueCertForm">
        {% csrf_token %}
        
        <!-- Hidden Context Fields -->
        <input type="hidden" name="certificate_for" id="certificateFor">
        <input type="hidden" name="selected_course_id" id="selectedCourseId">
        <input type="hidden" name="selected_batch_id" id="selectedBatchId">
        
        <!-- Step 1: Template -->
        <div class="form-card">
            <h5 class="mb-4">
                <span class="badge bg-primary me-2">1</span>
                Select Certificate Template
            </h5>
            <div class="row">
                {% for template in templates %}
                <div class="col-md-3 mb-3">
                    <label class="template-card" onclick="selectTemplate(this)">
                        <input type="radio" name="template_id" value="{{ template.id }}" 
                               class="form-check-input me-2" required>
                        <div>
                            <div class="fw-bold">{{ template.name }}</div>
                            <small class="text-muted">{{ template.certificate_type.name }}</small>
                        </div>
                    </label>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Step 2: Issue Type -->
        <div class="form-card">
            <h5 class="mb-4">
                <span class="badge bg-primary me-2">2</span>
                Select Issue Type
            </h5>
            <div class="btn-group w-100" role="group">
                <input type="radio" class="btn-check" name="issue_type" id="typeIndividual" 
                       value="individual" checked>
                <label class="btn btn-outline-primary" for="typeIndividual" onclick="showSection('individual')">
                    <i class="bi bi-person me-2"></i>Individual Students
                </label>

                <input type="radio" class="btn-check" name="issue_type" id="typeBatch" value="batch">
                <label class="btn btn-outline-primary" for="typeBatch" onclick="showSection('batch')">
                    <i class="bi bi-people me-2"></i>Entire Batch
                </label>

                <input type="radio" class="btn-check" name="issue_type" id="typeCourse" value="course">
                <label class="btn btn-outline-primary" for="typeCourse" onclick="showSection('course')">
                    <i class="bi bi-book me-2"></i>Entire Course
                </label>
            </div>
        </div>

        <!-- Step 3: Recipients -->
        <div class="form-card">
            <h5 class="mb-4">
                <span class="badge bg-primary me-2">3</span>
                Select Recipients
            </h5>

            <!-- Individual Section -->
            <div id="individualSection" class="recipient-section active">
                
                <div class="alert alert-info mb-4">
                    <i class="bi bi-lightbulb me-2"></i>
                    <strong>How it works:</strong>
                    <ol class="mb-0 mt-2">
                        <li>Filter students by Course or Batch</li>
                        <li>Select students</li>
                        <li>Choose certificate type (Course or Batch)</li>
                    </ol>
                </div>

                <!-- Filters -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <label class="form-label fw-bold">
                            <i class="bi bi-book me-2"></i>Filter by Course
                        </label>
                        <select class="form-select form-select-lg" id="courseFilter">
                            <option value="">All Students</option>
                            {% for course in courses %}
                            <option value="{{ course.id }}" data-name="{{ course.title }}">
                                {{ course.title }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-bold">
                            <i class="bi bi-people me-2"></i>Filter by Batch
                        </label>
                        <select class="form-select form-select-lg" id="batchFilter">
                            <option value="">All Students</option>
                            {% for batch in batches %}
                            <option value="{{ batch.id }}" 
                                    data-name="{{ batch.name }}"
                                    data-course-id="{{ batch.course.id }}"
                                    data-course-name="{{ batch.course.title }}">
                                {{ batch.name }} - {{ batch.course.title }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <!-- Student List -->
                <div class="mb-3">
                    <input type="text" class="form-control" placeholder="üîç Search students..." 
                           id="studentSearch" onkeyup="filterStudents()">
                </div>

                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="selectAll" onclick="toggleAll()">
                    <label class="form-check-label fw-bold">Select All</label>
                </div>

                <div id="studentsList" style="max-height: 400px; overflow-y: auto;">
                    {% for student in students %}
                    <div class="student-item">
                        <input type="checkbox" class="form-check-input me-2" 
                               name="selected_students" value="{{ student.id }}" 
                               onchange="highlightStudent(this)">
                        <strong>{{ student.get_full_name|default:student.username }}</strong>
                        <br>
                        <small class="text-muted">{{ student.email }}</small>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Batch Section -->
            <div id="batchSection" class="recipient-section">
                <div class="alert alert-success mb-3">
                    <i class="bi bi-info-circle me-2"></i>
                    All students will receive <strong>Batch Certificates</strong> with batch name.
                </div>
                <select class="form-select form-select-lg" name="batch_id">
                    <option value="">Select Batch</option>
                    {% for batch in batches %}
                    <option value="{{ batch.id }}">
                        {{ batch.name }} - {{ batch.course.title }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <!-- Course Section -->
            <div id="courseSection" class="recipient-section">
                <div class="alert alert-success mb-3">
                    <i class="bi bi-info-circle me-2"></i>
                    All students will receive <strong>Course Certificates</strong> (no batch name).
                </div>
                <select class="form-select form-select-lg" name="course_id">
                    <option value="">Select Course</option>
                    {% for course in courses %}
                    <option value="{{ course.id }}">{{ course.title }}</option>
                    {% endfor %}
                </select>
            </div>

        </div>

        <!-- Submit -->
        <div class="form-card">
            <button type="button" onclick="handleIssue()" class="btn btn-primary btn-lg w-100">
                <i class="bi bi-award me-2"></i>Issue Certificates
            </button>
        </div>
    </form>

</div>

<!-- Context Selection Modal -->
<div class="context-modal" id="contextModal">
    <div class="modal-content-box">
        <div class="modal-header">
            <h2 class="modal-title">
                <i class="bi bi-question-circle text-primary me-2"></i>
                Choose Certificate Type
            </h2>
            <p class="modal-subtitle">
                Select whether this is a Course or Batch certificate
            </p>
        </div>

        <div id="courseOption" style="display: none;">
            <div class="context-option" onclick="selectContext('course')">
                <input type="radio" name="contextChoice" value="course" id="radioCourse">
                <div class="context-icon">
                    <i class="bi bi-book"></i>
                </div>
                <div class="context-title">Course Completion Certificate</div>
                <p class="context-desc">
                    General course certificate without specific batch mention.
                </p>
                <div class="context-for">
                    For: <strong id="courseNameModal"></strong>
                </div>
            </div>
        </div>

        <div id="batchOption" style="display: none;">
            <div class="context-option" onclick="selectContext('batch')">
                <input type="radio" name="contextChoice" value="batch" id="radioBatch">
                <div class="context-icon">
                    <i class="bi bi-people"></i>
                </div>
                <div class="context-title">Batch Completion Certificate</div>
                <p class="context-desc">
                    Specific batch certificate with batch name mentioned.
                </p>
                <div class="context-for">
                    For: <strong id="batchNameModal"></strong>
                </div>
            </div>
        </div>

        <div class="modal-actions">
            <button type="button" class="btn-confirm" onclick="confirmAndSubmit()">
                <i class="bi bi-check-circle me-2"></i>Confirm & Issue
            </button>
            <button type="button" class="btn-cancel" onclick="closeModal()">
                Cancel
            </button>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// Global variables
let selectedCourseId = null;
let selectedCourseName = '';
let selectedBatchId = null;
let selectedBatchName = '';
let selectedContext = null;

// Select Template
function selectTemplate(element) {
    document.querySelectorAll('.template-card').forEach(card => {
        card.classList.remove('selected');
    });
    element.classList.add('selected');
}

// Show Section
function showSection(type) {
    console.log('Showing section:', type);
    
    document.querySelectorAll('.recipient-section').forEach(section => {
        section.classList.remove('active');
    });
    
    document.getElementById(type + 'Section').classList.add('active');
}

// Course Filter
document.getElementById('courseFilter').addEventListener('change', function() {
    const option = this.options[this.selectedIndex];
    
    if (this.value) {
        selectedCourseId = this.value;
        selectedCourseName = option.dataset.name;
        selectedBatchId = null;
        selectedBatchName = '';
        
        // Clear batch filter
        document.getElementById('batchFilter').value = '';
        
        console.log('Course selected:', selectedCourseName);
    } else {
        selectedCourseId = null;
        selectedCourseName = '';
    }
});

// Batch Filter
document.getElementById('batchFilter').addEventListener('change', function() {
    const option = this.options[this.selectedIndex];
    
    if (this.value) {
        selectedBatchId = this.value;
        selectedBatchName = option.dataset.name;
        selectedCourseId = option.dataset.courseId;
        selectedCourseName = option.dataset.courseName;
        
        // Clear course filter
        document.getElementById('courseFilter').value = '';
        
        console.log('Batch selected:', selectedBatchName);
    } else {
        selectedBatchId = null;
        selectedBatchName = '';
    }
});

// Highlight Student
function highlightStudent(checkbox) {
    if (checkbox.checked) {
        checkbox.closest('.student-item').classList.add('selected');
    } else {
        checkbox.closest('.student-item').classList.remove('selected');
    }
}

// Toggle All
function toggleAll() {
    const checked = document.getElementById('selectAll').checked;
    document.querySelectorAll('input[name="selected_students"]').forEach(cb => {
        if (cb.closest('.student-item').style.display !== 'none') {
            cb.checked = checked;
            highlightStudent(cb);
        }
    });
}

// Filter Students
function filterStudents() {
    const query = document.getElementById('studentSearch').value.toLowerCase();
    document.querySelectorAll('.student-item').forEach(item => {
        const text = item.textContent.toLowerCase();
        item.style.display = text.includes(query) ? 'block' : 'none';
    });
}

// Handle Issue Button
function handleIssue() {
    console.log('Handle Issue clicked');
    
    const issueType = document.querySelector('input[name="issue_type"]:checked').value;
    console.log('Issue type:', issueType);
    
    if (issueType === 'individual') {
        // Check students selected
        const selected = document.querySelectorAll('input[name="selected_students"]:checked');
        
        if (selected.length === 0) {
            alert('‚ö†Ô∏è Please select at least one student!');
            return;
        }
        
        console.log('Students selected:', selected.length);
        
        // Check if filter applied
        if (!selectedCourseId && !selectedBatchId) {
            alert('‚ö†Ô∏è Please filter by Course or Batch first!');
            return;
        }
        
        // Show modal
        showModal();
        
    } else {
        // Direct submit for batch/course
        document.getElementById('issueCertForm').submit();
    }
}

// Show Modal
function showModal() {
    console.log('Opening modal...');
    console.log('Course ID:', selectedCourseId);
    console.log('Batch ID:', selectedBatchId);
    
    const modal = document.getElementById('contextModal');
    const courseOption = document.getElementById('courseOption');
    const batchOption = document.getElementById('batchOption');
    
    // Reset
    courseOption.style.display = 'none';
    batchOption.style.display = 'none';
    document.querySelectorAll('.context-option').forEach(opt => {
        opt.classList.remove('active');
    });
    
    // Show relevant options
    if (selectedBatchId) {
        // Both options
        courseOption.style.display = 'block';
        batchOption.style.display = 'block';
        document.getElementById('courseNameModal').textContent = selectedCourseName;
        document.getElementById('batchNameModal').textContent = `${selectedBatchName} (${selectedCourseName})`;
    } else if (selectedCourseId) {
        // Only course
        courseOption.style.display = 'block';
        document.getElementById('courseNameModal').textContent = selectedCourseName;
        // Auto-select course
        document.getElementById('radioCourse').checked = true;
        document.querySelector('#courseOption .context-option').classList.add('active');
        selectedContext = 'course';
    }
    
    modal.classList.add('show');
    console.log('Modal opened!');
}

// Close Modal
function closeModal() {
    console.log('Closing modal');
    document.getElementById('contextModal').classList.remove('show');
}

// Select Context
function selectContext(type) {
    console.log('Context selected:', type);
    
    // Remove active
    document.querySelectorAll('.context-option').forEach(opt => {
        opt.classList.remove('active');
    });
    
    // Add active
    event.currentTarget.classList.add('active');
    
    // Check radio
    if (type === 'course') {
        document.getElementById('radioCourse').checked = true;
    } else {
        document.getElementById('radioBatch').checked = true;
    }
    
    selectedContext = type;
}

// Confirm and Submit
function confirmAndSubmit() {
    console.log('Confirm clicked, context:', selectedContext);
    
    if (!selectedContext) {
        alert('‚ö†Ô∏è Please select a certificate type!');
        return;
    }
    
    // Set hidden fields
    document.getElementById('certificateFor').value = selectedContext;
    document.getElementById('selectedCourseId').value = selectedCourseId || '';
    document.getElementById('selectedBatchId').value = selectedBatchId || '';
    
    console.log('Submitting form...');
    console.log('certificateFor:', selectedContext);
    console.log('selectedCourseId:', selectedCourseId);
    console.log('selectedBatchId:', selectedBatchId);
    
    // Close modal
    closeModal();
    
    // Submit form
    document.getElementById('issueCertForm').submit();
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    console.log('Page loaded');
    showSection('individual');
});
</script>
{% endblock %}
