{% extends 'students/student_base.html' %}
{% load static %}

{% block title %}My Attendance{% endblock %}

{% block content %}
<style>
    .attendance-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 2rem;
    }

    /* Header Section */
    .attendance-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 2.5rem;
        border-radius: 15px;
        margin-bottom: 2rem;
        box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
    }

    .attendance-header h1 {
        font-size: 2rem;
        font-weight: 700;
        margin: 0 0 0.5rem 0;
    }

    .attendance-header p {
        margin: 0;
        opacity: 0.9;
    }

    /* Stats Cards */
    .stats-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .stat-card {
        background: white;
        padding: 1.5rem;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        text-align: center;
        border-top: 4px solid;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 20px rgba(0,0,0,0.15);
    }

    .stat-card.total { border-top-color: #3b82f6; }
    .stat-card.present { border-top-color: #10b981; }
    .stat-card.absent { border-top-color: #ef4444; }
    .stat-card.late { border-top-color: #f59e0b; }

    .stat-icon {
        font-size: 2.5rem;
        margin-bottom: 0.5rem;
    }

    .stat-number {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
    }

    .stat-card.total .stat-number { color: #3b82f6; }
    .stat-card.present .stat-number { color: #10b981; }
    .stat-card.absent .stat-number { color: #ef4444; }
    .stat-card.late .stat-number { color: #f59e0b; }

    .stat-label {
        font-size: 0.9rem;
        color: #6b7280;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    /* Progress Section */
    .progress-card {
        background: white;
        padding: 2rem;
        border-radius: 15px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        margin-bottom: 2rem;
        text-align: center;
    }

    .circular-progress-wrapper {
        position: relative;
        width: 200px;
        height: 200px;
        margin: 0 auto 1.5rem;
    }

    .circular-progress {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        background: conic-gradient(
            #667eea 0deg,
            #667eea calc(var(--progress) * 3.6deg),
            #e5e7eb calc(var(--progress) * 3.6deg),
            #e5e7eb 360deg
        );
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .circular-progress-inner {
        width: 85%;
        height: 85%;
        background: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
    }

    .progress-percentage {
        font-size: 2.5rem;
        font-weight: 800;
        color: #667eea;
    }

    .progress-label {
        font-size: 0.9rem;
        color: #6b7280;
        font-weight: 600;
    }

    .progress-status {
        display: inline-block;
        padding: 0.75rem 1.5rem;
        border-radius: 25px;
        font-weight: 600;
        margin-top: 1rem;
    }

    .status-excellent { background: #d1fae5; color: #065f46; }
    .status-warning { background: #fef3c7; color: #92400e; }
    .status-critical { background: #fee2e2; color: #991b1b; }

    /* All Sessions Section */
    .upcoming-sessions {
        background: white;
        padding: 2rem;
        border-radius: 15px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        margin-bottom: 2rem;
    }

    .section-title {
        font-size: 1.5rem;
        font-weight: 700;
        color: #1f2937;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid #e5e7eb;
    }

    .session-card {
        background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
        padding: 1.5rem;
        border-radius: 12px;
        margin-bottom: 1rem;
        border-left: 5px solid #3b82f6;
        transition: all 0.3s ease;
    }

    .session-card.upcoming {
        background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
        border-left-color: #10b981;
    }

    .session-card.running {
        background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
        border-left-color: #f59e0b;
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.9; }
    }

    .session-card.past {
        background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
        border-left-color: #6b7280;
        opacity: 0.85;
    }

    .session-card:hover {
        transform: translateX(5px);
        box-shadow: 0 5px 15px rgba(59, 130, 246, 0.2);
    }

    .session-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }

    .session-batch {
        font-weight: 700;
        color: #1f2937;
        font-size: 1.1rem;
    }

    .session-badge {
        background: #3b82f6;
        color: white;
        padding: 0.4rem 0.8rem;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
    }

    .session-badge.upcoming-badge {
        background: #10b981;
    }

    .session-badge.past-badge {
        background: #6b7280;
    }

    .session-details {
        display: flex;
        gap: 2rem;
        color: #6b7280;
        font-size: 0.95rem;
        margin-bottom: 1rem;
    }

    .session-detail-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .mark-attendance-btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        text-decoration: none;
        display: inline-block;
        font-weight: 600;
        transition: all 0.3s ease;
        border: none;
        cursor: pointer;
    }

    .mark-attendance-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        color: white;
    }

    /* Batch Stats */
    .batch-stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .batch-card {
        background: white;
        padding: 1.5rem;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        border-left: 5px solid #667eea;
    }

    .batch-name {
        font-weight: 700;
        color: #1f2937;
        margin-bottom: 1rem;
        font-size: 1.1rem;
    }

    .batch-mini-stats {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 1rem;
        margin-bottom: 1rem;
        text-align: center;
    }

    .batch-stat-value {
        font-size: 1.5rem;
        font-weight: 700;
    }

    .batch-stat-label {
        font-size: 0.75rem;
        color: #9ca3af;
        font-weight: 600;
    }

    .batch-progress-bar {
        background: #e5e7eb;
        border-radius: 10px;
        height: 8px;
        overflow: hidden;
        margin-top: 1rem;
    }

    .batch-progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #667eea, #764ba2);
        border-radius: 10px;
        transition: width 1s ease;
    }

    .batch-progress-text {
        text-align: center;
        margin-top: 0.5rem;
        font-size: 0.85rem;
        color: #6b7280;
        font-weight: 600;
    }

    /* Recent Records */
    .recent-records {
        background: white;
        padding: 2rem;
        border-radius: 15px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        margin-bottom: 2rem;
    }

    .attendance-item {
        background: #f9fafb;
        padding: 1.5rem;
        border-radius: 10px;
        margin-bottom: 1rem;
        border-left: 5px solid;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: all 0.3s ease;
    }

    .attendance-item:hover {
        transform: translateX(5px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    .attendance-item.present { 
        border-left-color: #10b981; 
        background: linear-gradient(135deg, #f0fdf4 0%, #ecfdf5 100%);
    }

    .attendance-item.absent { 
        border-left-color: #ef4444; 
        background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
    }

    .attendance-item.late { 
        border-left-color: #f59e0b; 
        background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
    }

    .attendance-info {
        flex: 1;
    }

    .attendance-status-row {
        display: flex;
        gap: 1rem;
        align-items: center;
        margin-bottom: 0.5rem;
    }

    .status-badge {
        padding: 0.4rem 0.9rem;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 700;
        text-transform: uppercase;
    }

    .status-badge.present { background: #d1fae5; color: #065f46; }
    .status-badge.absent { background: #fee2e2; color: #991b1b; }
    .status-badge.late { background: #fef3c7; color: #92400e; }

    .attendance-batch-name {
        font-weight: 700;
        color: #1f2937;
    }

    .attendance-details-text {
        font-size: 0.9rem;
        color: #6b7280;
        margin-top: 0.3rem;
    }

    .attendance-method-badge {
        background: white;
        padding: 0.5rem 1rem;
        border-radius: 8px;
        font-size: 0.85rem;
        color: #6b7280;
        font-weight: 600;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }

    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 3rem 1rem;
    }

    .empty-icon {
        font-size: 4rem;
        margin-bottom: 1rem;
        opacity: 0.5;
    }

    .empty-title {
        font-size: 1.3rem;
        font-weight: 700;
        color: #1f2937;
        margin-bottom: 0.5rem;
    }

    .empty-text {
        color: #6b7280;
    }

    /* Quick Actions */
    .quick-actions {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.5rem;
        margin-top: 2rem;
    }

    .action-btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 1.5rem;
        border-radius: 12px;
        text-decoration: none;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        transition: all 0.3s ease;
    }

    .action-btn:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        color: white;
    }

    .action-btn.secondary {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }

    .action-info h3 {
        font-size: 1.2rem;
        font-weight: 700;
        margin: 0 0 0.3rem 0;
    }

    .action-info p {
        margin: 0;
        opacity: 0.9;
    }

    .action-arrow {
        font-size: 2rem;
    }

    /* Responsive */
    @media (max-width: 768px) {
        .attendance-container {
            padding: 1rem;
        }

        .stats-row {
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }

        .attendance-item {
            flex-direction: column;
            align-items: flex-start;
            gap: 1rem;
        }

        .session-details {
            flex-direction: column;
            gap: 0.5rem;
        }
    }
</style>

<div class="attendance-container">
    <!-- Header -->
    <div class="attendance-header">
        <h1>üìä My Attendance</h1>
        <p>Track your attendance across all courses</p>
    </div>

    <!-- Stats Cards -->
    <div class="stats-row">
        <div class="stat-card total">
            <div class="stat-icon">üìã</div>
            <div class="stat-number">{{ total_sessions }}</div>
            <div class="stat-label">Total Sessions</div>
        </div>

        <div class="stat-card present">
            <div class="stat-icon">‚úÖ</div>
            <div class="stat-number">{{ present_count }}</div>
            <div class="stat-label">Present</div>
        </div>

        <div class="stat-card absent">
            <div class="stat-icon">‚ùå</div>
            <div class="stat-number">{{ absent_count }}</div>
            <div class="stat-label">Absent</div>
        </div>

        <div class="stat-card late">
            <div class="stat-icon">‚ö†Ô∏è</div>
            <div class="stat-number">{{ late_count }}</div>
            <div class="stat-label">Late</div>
        </div>
    </div>

    <!-- Overall Progress -->
    <div class="progress-card">
        <div class="circular-progress-wrapper">
            <div class="circular-progress" style="--progress: {{ attendance_percentage }}">
                <div class="circular-progress-inner">
                    <div class="progress-percentage">{{ attendance_percentage|floatformat:0 }}%</div>
                    <div class="progress-label">Overall</div>
                </div>
            </div>
        </div>
        <h2 style="margin: 0 0 0.5rem 0; color: #1f2937;">Overall Attendance</h2>
        {% if attendance_percentage >= 75 %}
            <div class="progress-status status-excellent">‚úÖ Excellent! Keep up the good work!</div>
        {% elif attendance_percentage >= 60 %}
            <div class="progress-status status-warning">‚ö†Ô∏è Needs improvement - Aim for 75%+</div>
        {% else %}
            <div class="progress-status status-critical">‚ùå Critical - Below 60%</div>
        {% endif %}
    </div>

    <!-- üéØ ALL SESSIONS (Past + Running + Upcoming) - YAHAN CHANGE HAI! -->
    <!-- üéØ ALL SESSIONS with Smart Status Display -->
{% if sessions_with_status %}
<div class="upcoming-sessions">
    <div class="section-title">üìÖ All Sessions ({{ sessions_with_status|length }} Total)</div>
    {% for item in sessions_with_status %}
    <div class="session-card {{ item.status }}">
        <div class="session-header">
            <div class="session-batch">{{ item.session.batch.name }}</div>
            <div style="display: flex; gap: 0.5rem; align-items: center;">
                <!-- Session Status Badge -->
                {% if item.is_upcoming %}
                    <div class="session-badge upcoming-badge">üîú Upcoming</div>
                {% elif item.is_running %}
                    <div class="session-badge" style="background: #f59e0b;">‚ñ∂Ô∏è Running Now</div>
                {% else %}
                    <div class="session-badge past-badge">‚úÖ Past</div>
                {% endif %}
                
                <!-- Attendance Status Badge -->
                {% if item.has_attendance %}
                    {% if item.is_present %}
                        {% if item.is_late %}
                            <div class="session-badge" style="background: #f59e0b;">‚ö†Ô∏è Marked (Late)</div>
                        {% else %}
                            <div class="session-badge" style="background: #10b981;">‚úÖ Marked (Present)</div>
                        {% endif %}
                    {% else %}
                        <div class="session-badge" style="background: #ef4444;">‚ùå Marked (Absent)</div>
                    {% endif %}
                {% elif item.has_pending_request %}
                    <div class="session-badge" style="background: #f59e0b;">‚è≥ Request Pending</div>
                {% endif %}
            </div>
        </div>
        
        <div class="session-details">
            <div class="session-detail-item">
                <i class="fas fa-calendar"></i>
                <span>{{ item.session.start_time|date:"D, d M Y" }}</span>
            </div>
            <div class="session-detail-item">
                <i class="fas fa-clock"></i>
                <span>{{ item.session.start_time|time:"h:i A" }} - {{ item.session.end_time|time:"h:i A" }}</span>
            </div>
            <div class="session-detail-item">
                <i class="fas fa-map-marker-alt"></i>
                <span>{{ item.session.classroom_location|default:"Classroom" }}</span>
            </div>
        </div>
        
        <!-- Smart Action Buttons -->
        <div style="margin-top: 1rem; display: flex; gap: 1rem; flex-wrap: wrap;">
            {% if item.has_attendance %}
                <!-- Already Marked -->
                {% if item.is_present %}
                    <div style="background: #d1fae5; color: #065f46; padding: 0.75rem 1.5rem; border-radius: 8px; font-weight: 600; display: flex; align-items: center; gap: 0.5rem;">
                        <i class="fas fa-check-circle"></i>
                        <span>Attendance Marked Successfully!</span>
                    </div>
                    {% if item.attendance.distance_from_classroom %}
                        <div style="background: #e0f2fe; color: #0c4a6e; padding: 0.75rem 1rem; border-radius: 8px; font-size: 0.9rem;">
                            üìç Distance: {{ item.attendance.distance_from_classroom }}m
                        </div>
                    {% endif %}
                {% else %}
                    <!-- Absent - Allow Manual Request -->
                    <div style="background: #fee2e2; color: #991b1b; padding: 0.75rem 1.5rem; border-radius: 8px; font-weight: 600; display: flex; align-items: center; gap: 0.5rem;">
                        <i class="fas fa-times-circle"></i>
                        <span>Marked Absent (Outside Radius)</span>
                    </div>
                    {% if not item.has_pending_request %}
                        <a href="{% url 'attendance:student_scanner' %}?session_id={{ item.session.id }}" 
                           class="mark-attendance-btn" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                            üìù Request Manual Attendance
                        </a>
                    {% else %}
                        <div style="background: #fef3c7; color: #92400e; padding: 0.75rem 1.5rem; border-radius: 8px; font-weight: 600;">
                            ‚è≥ Manual Request Pending Approval
                        </div>
                    {% endif %}
                {% endif %}
            {% else %}
                <!-- Not Marked Yet -->
                {% if item.is_running %}
                    <a href="{% url 'attendance:student_scanner' %}?session_id={{ item.session.id }}" 
                       class="mark-attendance-btn" style="animation: pulse 2s infinite;">
                        ‚ñ∂Ô∏è Mark Attendance NOW (Running)
                    </a>
                {% elif item.is_upcoming %}
                    <a href="{% url 'attendance:student_scanner' %}?session_id={{ item.session.id }}" 
                       class="mark-attendance-btn">
                        üîú Mark Attendance (Starting Soon)
                    </a>
                {% else %}
                    <!-- Past Session - Allow Manual Request -->
                    {% if not item.has_pending_request %}
                        <a href="{% url 'attendance:student_scanner' %}?session_id={{ item.session.id }}" 
                           class="mark-attendance-btn" style="background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);">
                            üìù Request Manual Attendance (Past)
                        </a>
                    {% else %}
                        <div style="background: #fef3c7; color: #92400e; padding: 0.75rem 1.5rem; border-radius: 8px; font-weight: 600;">
                            ‚è≥ Manual Request Pending Approval
                        </div>
                    {% endif %}
                {% endif %}
            {% endif %}
        </div>
    </div>
    {% endfor %}
</div>
{% else %}
<div class="upcoming-sessions">
    <div class="section-title">üìÖ All Sessions</div>
    <div class="empty-state">
        <div class="empty-icon">üì≠</div>
        <div class="empty-title">No Sessions Available</div>
        <div class="empty-text">No active sessions found for your enrolled batches</div>
    </div>
</div>
{% endif %}

    <!-- Batch-wise Stats -->
    {% if batch_stats %}
    <div class="upcoming-sessions">
        <div class="section-title">üìö Batch-wise Attendance</div>
        <div class="batch-stats-grid">
            {% for batch_name, stats in batch_stats.items %}
            <div class="batch-card">
                <div class="batch-name">{{ batch_name }}</div>
                <div class="batch-mini-stats">
                    <div>
                        <div class="batch-stat-value" style="color: #3b82f6;">{{ stats.total }}</div>
                        <div class="batch-stat-label">Total</div>
                    </div>
                    <div>
                        <div class="batch-stat-value" style="color: #10b981;">{{ stats.present }}</div>
                        <div class="batch-stat-label">Present</div>
                    </div>
                    <div>
                        <div class="batch-stat-value" style="color: #ef4444;">{{ stats.absent }}</div>
                        <div class="batch-stat-label">Absent</div>
                    </div>
                    <div>
                        <div class="batch-stat-value" style="color: #f59e0b;">{{ stats.late }}</div>
                        <div class="batch-stat-label">Late</div>
                    </div>
                </div>
                <div class="batch-progress-bar">
                    <div class="batch-progress-fill" style="width: {{ stats.percentage }}%"></div>
                </div>
                <div class="batch-progress-text">{{ stats.percentage|floatformat:0 }}% Attendance</div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Recent Records -->
    <div class="recent-records">
        <div class="section-title">üìù Recent Attendance Records</div>

        {% if attendances %}
            {% for attendance in attendances %}
            <div class="attendance-item {% if attendance.is_present %}{% if attendance.is_late %}late{% else %}present{% endif %}{% else %}absent{% endif %}">
                <div class="attendance-info">
                    <div class="attendance-status-row">
                        {% if attendance.is_present %}
                            {% if attendance.is_late %}
                                <span class="status-badge late">‚ö†Ô∏è Late</span>
                            {% else %}
                                <span class="status-badge present">‚úÖ Present</span>
                            {% endif %}
                        {% else %}
                            <span class="status-badge absent">‚ùå Absent</span>
                        {% endif %}
                        <span class="attendance-batch-name">{{ attendance.session.batch.name }}</span>
                    </div>
                    <div class="attendance-details-text">
                        üìÖ {{ attendance.session.start_time|date:"D, d M Y" }} | 
                        üïê {{ attendance.session.start_time|time:"h:i A" }} - {{ attendance.session.end_time|time:"h:i A" }}
                    </div>
                    {% if attendance.is_present %}
                    <div class="attendance-details-text">
                        ‚úì Marked at {{ attendance.marked_at|time:"h:i A" }}
                        {% if attendance.distance_from_classroom %}
                            | üìç {{ attendance.distance_from_classroom }}m away
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
                <div class="attendance-method-badge">
                    {{ attendance.get_marking_method_display }}
                </div>
            </div>
            {% endfor %}
        {% else %}
        <div class="empty-state">
            <div class="empty-icon">üì≠</div>
            <div class="empty-title">No Records Yet</div>
            <div class="empty-text">Your attendance will appear here once sessions start</div>
        </div>
        {% endif %}
    </div>

    <!-- Quick Actions -->
    <div class="quick-actions">
        <a href="{% url 'attendance:student_scanner' %}" class="action-btn">
            <div class="action-info">
                <h3>üì± Scan QR Code</h3>
                <p>Mark your attendance</p>
            </div>
            <div class="action-arrow">‚Üí</div>
        </a>
        
        <a href="{% url 'attendance:student_attendance_history' %}" class="action-btn secondary">
            <div class="action-info">
                <h3>üìä Full History</h3>
                <p>View all records</p>
            </div>
            <div class="action-arrow">‚Üí</div>
        </a>
    </div>
</div>
{% endblock %}