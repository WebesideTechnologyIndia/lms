{% extends 'base.html' %}

{% block title %}Assign Exam - LMS Admin{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h4 class="card-title">
                        <i class="fas fa-user-plus text-success"></i>
                        Assign Exam to Students
                    </h4>
                    <p class="text-muted mb-0">Assign exams to individual students, batches, or entire courses</p>
                </div>
                
                <div class="card-body">
                    <form method="post" id="assignExamForm">
                        {% csrf_token %}
                        
                        <!-- Exam Selection -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h5 class="text-primary border-bottom pb-2">
                                    <i class="fas fa-clipboard-list"></i> Select Exam
                                </h5>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-8">
                                <label class="form-label">Choose Exam *</label>
                                <select name="exam_id" id="exam_id" class="form-select" required>
                                    <option value="">-- Select an Exam --</option>
                                    {% for exam in exams %}
                                    <option value="{{ exam.id }}" data-type="{{ exam.exam_type }}" data-marks="{{ exam.total_marks }}">
                                        {{ exam.title }} ({{ exam.get_exam_type_display }} - {{ exam.total_marks }} marks)
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Assignment Type *</label>
                                <select name="assignment_type" id="assignment_type" class="form-select" required>
                                    <option value="">-- Select Type --</option>
                                    <option value="individual">Individual Student</option>
                                    <option value="batch">Entire Batch</option>
                                    <option value="course">Entire Course</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Assignment Targets -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h5 class="text-primary border-bottom pb-2">
                                    <i class="fas fa-users"></i> Assignment Targets
                                </h5>
                            </div>
                        </div>
                        
                        <!-- Individual Students Section -->
                        <div id="individual-section" class="assignment-section" style="display: none;">
                            <div class="row mb-3">
                                <div class="col-12">
                                    <label class="form-label fw-bold">Select Students</label>
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <input type="text" id="student-search" class="form-control" placeholder="üîç Search students by name or email...">
                                        </div>
                                        <div class="col-md-6">
                                            <button type="button" id="select-all-students" class="btn btn-outline-primary btn-sm">
                                                <i class="fas fa-check-square"></i> Select All
                                            </button>
                                            <button type="button" id="deselect-all-students" class="btn btn-outline-secondary btn-sm">
                                                <i class="fas fa-square"></i> Deselect All
                                            </button>
                                        </div>
                                    </div>
                                    
                                    {% if students %}
                                        <div class="student-list border rounded p-3 bg-light" style="max-height: 350px; overflow-y: auto;">
                                            <div class="mb-2">
                                                <small class="text-muted">
                                                    <i class="fas fa-info-circle"></i> 
                                                    Total Students: <strong>{{ students|length }}</strong>
                                                </small>
                                            </div>
                                            {% for student in students %}
                                            <div class="form-check student-item mb-2 p-2 rounded hover-bg">
                                                <input class="form-check-input" type="checkbox" name="selected_students" 
                                                       value="{{ student.id }}" id="student_{{ student.id }}">
                                                <label class="form-check-label w-100" for="student_{{ student.id }}" style="cursor: pointer;">
                                                    <div class="d-flex align-items-center">
                                                        <i class="fas fa-user-circle text-primary me-2"></i>
                                                        <div>
                                                            <strong>{{ student.get_full_name|default:student.username }}</strong>
                                                            <small class="text-muted d-block">
                                                                <i class="fas fa-envelope"></i> {{ student.email }}
                                                            </small>
                                                        </div>
                                                    </div>
                                                </label>
                                            </div>
                                            {% endfor %}
                                        </div>
                                    {% else %}
                                        <div class="alert alert-warning">
                                            <i class="fas fa-exclamation-triangle"></i> 
                                            No students available. Please add students first.
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <!-- Batch Section -->
                        <div id="batch-section" class="assignment-section" style="display: none;">
                            <div class="row mb-3">
                                <div class="col-12">
                                    <label class="form-label fw-bold">Select Batches</label>
                                    
                                    {% if batches %}
                                        <div class="mb-3">
                                            <small class="text-muted">
                                                <i class="fas fa-info-circle"></i> 
                                                Total Batches: <strong>{{ batches|length }}</strong>
                                            </small>
                                        </div>
                                        <div class="row">
                                            {% for batch in batches %}
                                            <div class="col-md-6 mb-3">
                                                <div class="card border-primary h-100 hover-shadow">
                                                    <div class="card-body p-3">
                                                        <div class="form-check">
                                                            <input class="form-check-input batch-checkbox" type="checkbox" name="selected_batches" 
                                                                   value="{{ batch.id }}" id="batch_{{ batch.id }}">
                                                            <label class="form-check-label w-100" for="batch_{{ batch.id }}" style="cursor: pointer;">
                                                                <div class="d-flex align-items-start">
                                                                    <i class="fas fa-users text-success me-2 mt-1"></i>
                                                                    <div class="flex-grow-1">
                                                                        <h6 class="mb-1">{{ batch.name }}</h6>
                                                                        <small class="text-muted">
                                                                            <i class="fas fa-book"></i> {{ batch.course.title }}<br>
                                                                            <i class="fas fa-chalkboard-teacher"></i> {{ batch.instructor.get_full_name|default:batch.instructor.username }}<br>
                                                                            <i class="fas fa-user-graduate"></i> 
                                                                            <span class="batch-student-count" data-batch-id="{{ batch.id }}">
                                                                                {{ batch.students.count }} student{{ batch.students.count|pluralize }}
                                                                            </span>
                                                                        </small>
                                                                    </div>
                                                                </div>
                                                            </label>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            {% endfor %}
                                        </div>
                                    {% else %}
                                        <div class="alert alert-warning">
                                            <i class="fas fa-exclamation-triangle"></i> 
                                            <strong>No batches found!</strong> Please create batches first before assigning exams.
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <!-- Course Section -->
                        <div id="course-section" class="assignment-section" style="display: none;">
                            <div class="row mb-3">
                                <div class="col-12">
                                    <label class="form-label fw-bold">Select Courses</label>
                                    
                                    {% if courses %}
                                        <div class="mb-3">
                                            <small class="text-muted">
                                                <i class="fas fa-info-circle"></i> 
                                                Total Courses: <strong>{{ courses|length }}</strong>
                                            </small>
                                        </div>
                                        <div class="row">
                                            {% for course in courses %}
                                            <div class="col-md-6 mb-3">
                                                <div class="card border-info h-100 hover-shadow">
                                                    <div class="card-body p-3">
                                                        <div class="form-check">
                                                            <input class="form-check-input course-checkbox" type="checkbox" name="selected_courses" 
                                                                   value="{{ course.id }}" id="course_{{ course.id }}">
                                                            <label class="form-check-label w-100" for="course_{{ course.id }}" style="cursor: pointer;">
                                                                <div class="d-flex align-items-start">
                                                                    <i class="fas fa-graduation-cap text-info me-2 mt-1"></i>
                                                                    <div class="flex-grow-1">
                                                                        <h6 class="mb-1">{{ course.title }}</h6>
                                                                        <small class="text-muted">
                                                                            <i class="fas fa-code"></i> Code: {{ course.course_code }}<br>
                                                                            <i class="fas fa-user-graduate"></i> 
                                                                            <span class="course-student-count" data-course-id="{{ course.id }}">
                                                                                Loading...
                                                                            </span>
                                                                        </small>
                                                                    </div>
                                                                </div>
                                                            </label>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            {% endfor %}
                                        </div>
                                    {% else %}
                                        <div class="alert alert-warning">
                                            <i class="fas fa-exclamation-triangle"></i> 
                                            <strong>No courses found!</strong> Please create courses first before assigning exams.
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <!-- Custom Timing (Optional) -->
                        <div class="row mb-4 mt-4">
                            <div class="col-12">
                                <h5 class="text-primary border-bottom pb-2">
                                    <i class="fas fa-clock"></i> Custom Timing (Optional)
                                </h5>
                                <p class="text-muted">Override default exam timing for this assignment</p>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Custom Start Date & Time</label>
                                <input type="datetime-local" name="custom_start_datetime" class="form-control">
                                <div class="form-text">Leave empty to use exam's default start time</div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Custom End Date & Time</label>
                                <input type="datetime-local" name="custom_end_datetime" class="form-control">
                                <div class="form-text">Leave empty to use exam's default end time</div>
                            </div>
                        </div>
                        
                        <!-- Assignment Summary -->
                        <div id="assignment-summary" class="row mb-4" style="display: none;">
                            <div class="col-12">
                                <div class="alert alert-success">
                                    <h6 class="mb-2"><i class="fas fa-check-circle"></i> Assignment Summary:</h6>
                                    <div id="summary-content"></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Action Buttons -->
                        <div class="row mt-4">
                            <div class="col-12">
                                <div class="d-flex gap-2">
                                    <button type="submit" class="btn btn-success" id="assign-btn" disabled>
                                        <i class="fas fa-user-plus"></i> Assign Exam
                                    </button>
                                    <a href="{% url 'exam_dashboard' %}" class="btn btn-secondary">
                                        <i class="fas fa-times"></i> Cancel
                                    </a>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Recent Assignments -->
    {% if recent_assignments %}
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-history text-info"></i>
                        Recent Assignments
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Exam</th>
                                    <th>Type</th>
                                    <th>Target</th>
                                    <th>Assigned By</th>
                                    <th>Date</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for assignment in recent_assignments %}
                                <tr>
                                    <td>
                                        <strong>{{ assignment.exam.title }}</strong>
                                        <small class="text-muted d-block">{{ assignment.exam.get_exam_type_display }}</small>
                                    </td>
                                    <td>
                                        <span class="badge bg-info">{{ assignment.get_assignment_type_display }}</span>
                                    </td>
                                    <td>
                                        {% if assignment.assignment_type == 'individual' %}
                                            {{ assignment.student.get_full_name|default:assignment.student.username }}
                                        {% elif assignment.assignment_type == 'batch' %}
                                            {{ assignment.batch.name }}
                                        {% else %}
                                            {{ assignment.course.title }}
                                        {% endif %}
                                    </td>
                                    <td>{{ assignment.assigned_by.get_full_name|default:assignment.assigned_by.username }}</td>
                                    <td>{{ assignment.assigned_at|date:"M d, Y H:i" }}</td>
                                    <td>
                                        {% if assignment.is_active %}
                                            <span class="badge bg-success">Active</span>
                                        {% else %}
                                            <span class="badge bg-secondary">Inactive</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<style>
    .assignment-section {
        min-height: 200px;
    }
    
    .hover-bg:hover {
        background-color: #f8f9fa;
        transition: background-color 0.3s ease;
    }
    
    .hover-shadow {
        transition: box-shadow 0.3s ease, transform 0.3s ease;
    }
    
    .hover-shadow:hover {
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
        transform: translateY(-2px);
    }
    
    .student-list::-webkit-scrollbar {
        width: 8px;
    }
    
    .student-list::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
    }
    
    .student-list::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 10px;
    }
    
    .student-list::-webkit-scrollbar-thumb:hover {
        background: #555;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
// Check if jQuery is loaded
(function() {
    if (typeof jQuery === 'undefined') {
        // console.error('‚ùå jQuery is NOT loaded! Loading from CDN...');
        var script = document.createElement('script');
        script.src = 'https://code.jquery.com/jquery-3.6.0.min.js';
        script.onload = function() {
            // console.log('‚úÖ jQuery loaded from CDN');
            initializeAssignExam();
        };
        document.head.appendChild(script);
    } else {
        // console.log('‚úÖ jQuery already loaded');
        initializeAssignExam();
    }
})();

function initializeAssignExam() {
    $(document).ready(function() {
        // console.log('=== Assign Exam Page Initialized ===');
        // console.log('üìä Data Available:');
        // console.log('  - Exams:', {{ exams|length }});
        // console.log('  - Students:', {{ students|length }});
        // console.log('  - Batches:', {{ batches|length }});
        // console.log('  - Courses:', {{ courses|length }});
        
        // Assignment type change
        $('#assignment_type').on('change', function() {
            var type = $(this).val();
            // console.log('üìù Assignment type changed:', type);
            
            // Hide all sections
            $('.assignment-section').hide();
            
            // Show selected section
            if (type === 'individual') {
                $('#individual-section').show();
                // console.log('‚úÖ Individual section shown');
            } else if (type === 'batch') {
                $('#batch-section').show();
                // console.log('‚úÖ Batch section shown');
                loadCourseStudentCounts(); // Load counts when batch section opens
            } else if (type === 'course') {
                $('#course-section').show();
                // console.log('‚úÖ Course section shown');
                loadCourseStudentCounts(); // Load counts when course section opens
            }
            
            updateAssignButton();
            updateSummary();
        });
        
        // Exam selection
        $('#exam_id').on('change', function() {
            // console.log('üìã Exam selected:', $(this).find(':selected').text());
            updateAssignButton();
            updateSummary();
        });
        
        // Student search
        $('#student-search').on('input', function() {
            var searchTerm = $(this).val().toLowerCase();
            var visibleCount = 0;
            
            $('.student-item').each(function() {
                var text = $(this).find('label').text().toLowerCase();
                if (text.includes(searchTerm)) {
                    $(this).show();
                    visibleCount++;
                } else {
                    $(this).hide();
                }
            });
            
            // console.log('üîç Search:', visibleCount, 'students visible');
        });
        
        // Select all students
        $('#select-all-students').on('click', function() {
            var visible = $('.student-item:visible input[type="checkbox"]');
            visible.prop('checked', true);
            // console.log('‚úîÔ∏è Selected', visible.length, 'students');
            updateAssignButton();
            updateSummary();
        });
        
        // Deselect all students
        $('#deselect-all-students').on('click', function() {
            $('.student-item input[type="checkbox"]').prop('checked', false);
            // console.log('‚ùå Deselected all students');
            updateAssignButton();
            updateSummary();
        });
        
        // Checkbox change
        $(document).on('change', 'input[type="checkbox"]', function() {
            var name = $(this).attr('name');
            var checked = $('input[name="' + name + '"]:checked').length;
            // console.log('‚òëÔ∏è', name, '- checked:', checked);
            updateAssignButton();
            updateSummary();
        });
        
        // Load course student counts via AJAX
        function loadCourseStudentCounts() {
            // console.log('üìä Loading course student counts...');
            
            $('.course-student-count').each(function() {
                var $element = $(this);
                var courseId = $element.data('course-id');
                
                $.ajax({
                    url: '/exams/api/course/' + courseId + '/students/',
                    method: 'GET',
                    success: function(data) {
                        if (data.success) {
                            var count = data.total_count || 0;
                            $element.text(count + ' student' + (count !== 1 ? 's' : ''));
                            // console.log('  ‚úì Course', courseId, ':', count, 'students');
                        } else {
                            $element.text('0 students');
                        }
                    },
                    error: function(xhr, status, error) {
                        // console.warn('  ‚ö†Ô∏è Error loading count for course', courseId, ':', error);
                        $element.text('N/A');
                    }
                });
            });
        }
        
        // Update assign button state
        function updateAssignButton() {
            var examSelected = $('#exam_id').val();
            var typeSelected = $('#assignment_type').val();
            var targetsSelected = false;
            
            if (typeSelected === 'individual') {
                targetsSelected = $('input[name="selected_students"]:checked').length > 0;
            } else if (typeSelected === 'batch') {
                targetsSelected = $('input[name="selected_batches"]:checked').length > 0;
            } else if (typeSelected === 'course') {
                targetsSelected = $('input[name="selected_courses"]:checked').length > 0;
            }
            
            var canEnable = examSelected && typeSelected && targetsSelected;
            $('#assign-btn').prop('disabled', !canEnable);
            
            // console.log('üîò Button state:', canEnable ? 'ENABLED' : 'DISABLED');
        }
        
        // Update summary
        function updateSummary() {
            var examTitle = $('#exam_id option:selected').text();
            var type = $('#assignment_type').val();
            var typeName = $('#assignment_type option:selected').text();
            var selectedCount = 0;
            var selectedItems = [];
            
            if (type === 'individual') {
                $('input[name="selected_students"]:checked').each(function() {
                    selectedCount++;
                    var name = $(this).next('label').find('strong').first().text();
                    selectedItems.push(name);
                });
            } else if (type === 'batch') {
                $('input[name="selected_batches"]:checked').each(function() {
                    selectedCount++;
                    var name = $(this).next('label').find('h6').text();
                    selectedItems.push(name);
                });
            } else if (type === 'course') {
                $('input[name="selected_courses"]:checked').each(function() {
                    selectedCount++;
                    var name = $(this).next('label').find('h6').text();
                    selectedItems.push(name);
                });
            }
            
            if (selectedCount > 0 && $('#exam_id').val()) {
                var summary = '<strong>Exam:</strong> ' + examTitle + '<br>';
                summary += '<strong>Type:</strong> ' + typeName + '<br>';
                summary += '<strong>Selected:</strong> ' + selectedCount + ' item(s)';
                
                if (selectedItems.length > 0) {
                    if (selectedItems.length <= 5) {
                        summary += '<br><strong>Items:</strong> ' + selectedItems.join(', ');
                    } else {
                        summary += '<br><strong>Items:</strong> ' + selectedItems.slice(0, 5).join(', ') + ' and ' + (selectedItems.length - 5) + ' more...';
                    }
                }
                
                $('#summary-content').html(summary);
                $('#assignment-summary').show();
            } else {
                $('#assignment-summary').hide();
            }
        }
        
        // Form validation
        $('#assignExamForm').on('submit', function(e) {
            var examId = $('#exam_id').val();
            var type = $('#assignment_type').val();
            
            if (!examId) {
                e.preventDefault();
                alert('‚ö†Ô∏è Please select an exam!');
                return false;
            }
            
            if (!type) {
                e.preventDefault();
                alert('‚ö†Ô∏è Please select assignment type!');
                return false;
            }
            
            var hasTargets = false;
            var errorMsg = '';
            
            if (type === 'individual') {
                hasTargets = $('input[name="selected_students"]:checked').length > 0;
                errorMsg = '‚ö†Ô∏è Please select at least one student!';
            } else if (type === 'batch') {
                hasTargets = $('input[name="selected_batches"]:checked').length > 0;
                errorMsg = '‚ö†Ô∏è Please select at least one batch!';
            } else if (type === 'course') {
                hasTargets = $('input[name="selected_courses"]:checked').length > 0;
                errorMsg = '‚ö†Ô∏è Please select at least one course!';
            }
            
            if (!hasTargets) {
                e.preventDefault();
                alert(errorMsg);
                return false;
            }
            
            // console.log('‚úÖ Form validation passed - submitting...');
            return true;
        });
        
        // console.log('=== Initialization Complete ===');
    });
}
</script>
{% endblock %}