{% extends 'base.html' %}

{% block title %}Exam Submissions - LMS Admin{% endblock %}

{% block extra_css %}
<style>
    /* Fix dropdown visibility */
    .table-responsive {
        overflow: visible !important;
    }
    
    .card-body {
        overflow: visible !important;
    }
    
    /* Ensure dropdown appears above other elements */
    .dropdown-menu {
        z-index: 1050 !important;
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15) !important;
    }
    
    /* Avatar styling */
    .avatar-sm {
        width: 40px;
        height: 40px;
        font-size: 18px;
        font-weight: bold;
    }
    
    /* Progress bar styling */
    .progress {
        background-color: #e9ecef;
    }
    
    /* Make table scrollable on mobile while keeping dropdowns visible */
    @media (max-width: 768px) {
        .table-wrapper {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .table-wrapper .table {
            min-width: 1000px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header with Statistics -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h4 class="mb-0">
                        <i class="fas fa-clipboard-check text-primary"></i>
                        Exam Submissions & Results
                    </h4>
                    <p class="text-muted mb-0">View and manage student exam submissions, grades, and results</p>
                </div>
                <div class="d-flex gap-2">
                    <a href="{% url 'pending_grading' %}" class="btn btn-warning">
                        <i class="fas fa-clock"></i>
                        Pending Grading ({{ pending_grading }})
                    </a>
                    <a href="{% url 'exam_dashboard' %}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> Back to Dashboard
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h5 class="card-title mb-0">{{ total_attempts }}</h5>
                            <p class="card-text">Total Attempts</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-users fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h5 class="card-title mb-0">{{ pending_grading }}</h5>
                            <p class="card-text">Pending Grading</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-clock fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h5 class="card-title mb-0">{{ attempts.object_list|length }}</h5>
                            <p class="card-text">Showing Results</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-list fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h5 class="card-title mb-0">{{ exams.count }}</h5>
                            <p class="card-text">Published Exams</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-clipboard-list fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-filter"></i> Filter Submissions
                    </h6>
                </div>
                <div class="card-body">
                    <form method="get" id="filterForm">
                        <div class="row">
                            <div class="col-md-3">
                                <label class="form-label">Exam</label>
                                <select name="exam" class="form-select">
                                    <option value="">All Exams</option>
                                    {% for exam in exams %}
                                    <option value="{{ exam.id }}" {% if exam_filter == exam.id|stringformat:"s" %}selected{% endif %}>
                                        {{ exam.title }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Status</label>
                                <select name="status" class="form-select">
                                    <option value="">All Status</option>
                                    <option value="started" {% if status_filter == 'started' %}selected{% endif %}>Started</option>
                                    <option value="in_progress" {% if status_filter == 'in_progress' %}selected{% endif %}>In Progress</option>
                                    <option value="submitted" {% if status_filter == 'submitted' %}selected{% endif %}>Submitted</option>
                                    <option value="auto_submitted" {% if status_filter == 'auto_submitted' %}selected{% endif %}>Auto Submitted</option>
                                    <option value="abandoned" {% if status_filter == 'abandoned' %}selected{% endif %}>Abandoned</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Grading</label>
                                <select name="grading" class="form-select">
                                    <option value="">All</option>
                                    <option value="graded" {% if grading_filter == 'graded' %}selected{% endif %}>Graded</option>
                                    <option value="ungraded" {% if grading_filter == 'ungraded' %}selected{% endif %}>Ungraded</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Search Student</label>
                                <input type="text" name="search" class="form-control" placeholder="Student name or email..." value="{{ search_query }}">
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">&nbsp;</label>
                                <div class="d-flex gap-2">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-search"></i> Filter
                                    </button>
                                    <a href="{% url 'exam_submissions' %}" class="btn btn-outline-secondary">
                                        <i class="fas fa-times"></i> Clear
                                    </a>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Submissions Table -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-list"></i> Exam Submissions
                    </h6>
                </div>
                <div class="card-body" style="overflow: visible;">
                    {% if attempts %}
                    <div class="table-wrapper">
                        <div class="table-responsive" style="overflow: visible;">
                            <table class="table table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>Student</th>
                                        <th>Exam</th>
                                        <th>Type</th>
                                        <th>Attempt</th>
                                        <th>Status</th>
                                        <th>Score</th>
                                        <th>Percentage</th>
                                        <th>Grading</th>
                                        <th>Started</th>
                                        <th style="width: 120px;">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for attempt in attempts %}
                                    <tr>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <div class="avatar-sm bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-2">
                                                    {{ attempt.student.first_name|first|default:attempt.student.username|first }}
                                                </div>
                                                <div>
                                                    <strong>{{ attempt.student.get_full_name|default:attempt.student.username }}</strong>
                                                    <small class="text-muted d-block">{{ attempt.student.email }}</small>
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <strong>{{ attempt.exam.title }}</strong>
                                            <small class="text-muted d-block">{{ attempt.exam.total_marks }} marks</small>
                                        </td>
                                        <td>
                                            <span class="badge bg-secondary">{{ attempt.exam.get_exam_type_display }}</span>
                                        </td>
                                        <td>
                                            <span class="badge bg-info">#{{ attempt.attempt_number }}</span>
                                        </td>
                                        <td>
                                            {% if attempt.status == 'submitted' %}
                                            <span class="badge bg-success">Submitted</span>
                                            {% elif attempt.status == 'auto_submitted' %}
                                            <span class="badge bg-warning">Auto Submitted</span>
                                            {% elif attempt.status == 'in_progress' %}
                                            <span class="badge bg-primary">In Progress</span>
                                            {% elif attempt.status == 'started' %}
                                            <span class="badge bg-info">Started</span>
                                            {% else %}
                                            <span class="badge bg-secondary">{{ attempt.get_status_display }}</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if attempt.is_graded %}
                                            <strong>{{ attempt.total_marks_obtained|floatformat:1 }}/{{ attempt.exam.total_marks }}</strong>
                                            {% else %}
                                            <span class="text-muted">Not graded</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if attempt.is_graded %}
                                            <div class="d-flex align-items-center">
                                                <div class="progress flex-grow-1 me-2" style="height: 8px;">
                                                    <div class="progress-bar 
                                                            {% if attempt.percentage >= 60 %}bg-success
                                                            {% elif attempt.percentage >= 40 %}bg-warning
                                                            {% else %}bg-danger{% endif %}"
                                                        style="width: {{ attempt.percentage }}%">
                                                    </div>
                                                </div>
                                                <span class="fw-bold">{{ attempt.percentage|floatformat:1 }}%</span>
                                            </div>
                                            {% if attempt.is_passed %}
                                            <small class="text-success">✓ Passed</small>
                                            {% else %}
                                            <small class="text-danger">✗ Failed</small>
                                            {% endif %}
                                            {% else %}
                                            <span class="text-muted">-</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if attempt.exam.exam_type == 'mcq' %}
                                            {% if attempt.is_graded %}
                                            <span class="badge bg-success">Auto Graded</span>
                                            {% else %}
                                            <span class="badge bg-warning">Pending</span>
                                            {% endif %}
                                            {% else %}
                                            {% if attempt.is_graded %}
                                            <span class="badge bg-success">
                                                <i class="fas fa-check"></i> Graded
                                            </span>
                                            <small class="text-muted d-block">
                                                by {{ attempt.graded_by.get_full_name|default:attempt.graded_by.username }}
                                            </small>
                                            {% elif attempt.status in 'submitted,auto_submitted' %}
                                            <a href="{% if attempt.exam.exam_type == 'qa' %}{% url 'grade_qa_attempt' attempt.id %}{% else %}{% url 'grade_assignment_attempt' attempt.id %}{% endif %}" class="badge bg-warning text-decoration-none">
                                                <i class="fas fa-clock"></i> Grade Now
                                            </a>
                                            {% else %}
                                            <span class="badge bg-secondary">Not Submitted</span>
                                            {% endif %}
                                            {% endif %}
                                        </td>
                                        <td>
                                            <small class="text-muted">{{ attempt.started_at|date:"M d, Y" }}</small>
                                            <small class="text-muted d-block">{{ attempt.started_at|time:"H:i" }}</small>
                                        </td>
                                        <td>
                                            <div class="dropdown" style="position: relative;">
                                                <button class="btn btn-sm btn-outline-primary dropdown-toggle" 
                                                        type="button" 
                                                        id="dropdownMenuButton{{ attempt.id }}"
                                                        data-bs-toggle="dropdown" 
                                                        data-bs-auto-close="true"
                                                        aria-expanded="false">
                                                    Actions
                                                </button>
                                                <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdownMenuButton{{ attempt.id }}">
                                                    <li>
                                                        <a class="dropdown-item" href="{% url 'view_exam_attempt' attempt.id %}">
                                                            <i class="fas fa-eye"></i> View Details
                                                        </a>
                                                    </li>
                                                    {% if attempt.status in 'submitted,auto_submitted' and not attempt.is_graded %}
                                                    <li>
                                                        <a class="dropdown-item text-warning" href="{% if attempt.exam.exam_type == 'qa' %}{% url 'grade_qa_attempt' attempt.id %}{% else %}{% url 'grade_assignment_attempt' attempt.id %}{% endif %}">
                                                            <i class="fas fa-pen"></i> Grade Now
                                                        </a>
                                                    </li>
                                                    {% endif %}
                                                    {% if attempt.is_graded and attempt.exam.show_results_immediately %}
                                                    <li>
                                                        <a class="dropdown-item" href="{% url 'exam_result' attempt.id %}">
                                                            <i class="fas fa-chart-bar"></i> View Result
                                                        </a>
                                                    </li>
                                                    {% endif %}
                                                    <li>
                                                        <hr class="dropdown-divider">
                                                    </li>
                                                    <li>
                                                        <a class="dropdown-item text-info" href="#" onclick="downloadAttemptReport({{ attempt.id }}); return false;">
                                                            <i class="fas fa-download"></i> Download Report
                                                        </a>
                                                    </li>
                                                </ul>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Pagination -->
                    {% if attempts.has_other_pages %}
                    <nav aria-label="Pagination" class="mt-4">
                        <ul class="pagination justify-content-center">
                            {% if attempts.has_previous %}
                            <li class="page-item">
                                <a class="page-link" href="?{% if exam_filter %}exam={{ exam_filter }}&{% endif %}{% if status_filter %}status={{ status_filter }}&{% endif %}{% if grading_filter %}grading={{ grading_filter }}&{% endif %}{% if search_query %}search={{ search_query }}&{% endif %}page={{ attempts.previous_page_number }}">
                                    Previous
                                </a>
                            </li>
                            {% endif %}

                            {% for num in attempts.paginator.page_range %}
                            {% if num == attempts.number %}
                            <li class="page-item active">
                                <span class="page-link">{{ num }}</span>
                            </li>
                            {% elif num > attempts.number|add:'-3' and num < attempts.number|add:'3' %}
                            <li class="page-item">
                                <a class="page-link" href="?{% if exam_filter %}exam={{ exam_filter }}&{% endif %}{% if status_filter %}status={{ status_filter }}&{% endif %}{% if grading_filter %}grading={{ grading_filter }}&{% endif %}{% if search_query %}search={{ search_query }}&{% endif %}page={{ num }}">{{ num }}</a>
                            </li>
                            {% endif %}
                            {% endfor %}

                            {% if attempts.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="?{% if exam_filter %}exam={{ exam_filter }}&{% endif %}{% if status_filter %}status={{ status_filter }}&{% endif %}{% if grading_filter %}grading={{ grading_filter }}&{% endif %}{% if search_query %}search={{ search_query }}&{% endif %}page={{ attempts.next_page_number }}">
                                    Next
                                </a>
                            </li>
                            {% endif %}
                        </ul>
                    </nav>
                    {% endif %}

                    {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">No Exam Submissions Found</h5>
                        <p class="text-muted">No students have submitted exams matching your current filters.</p>
                        <a href="{% url 'assign_exam' %}" class="btn btn-primary">
                            <i class="fas fa-user-plus"></i> Assign Exams to Students
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-bolt"></i> Quick Actions
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <a href="{% url 'pending_grading' %}" class="btn btn-warning w-100">
                                <i class="fas fa-clock"></i>
                                <div>Pending Grading</div>
                                <small>({{ pending_grading }} items)</small>
                            </a>
                        </div>
                        <div class="col-md-3">
                            <a href="{% url 'create_exam' %}" class="btn btn-success w-100">
                                <i class="fas fa-plus"></i>
                                <div>Create New Exam</div>
                                <small>MCQ, Q&A, Assignment</small>
                            </a>
                        </div>
                        <div class="col-md-3">
                            <a href="{% url 'assign_exam' %}" class="btn btn-info w-100">
                                <i class="fas fa-user-plus"></i>
                                <div>Assign Exam</div>
                                <small>To students/batches</small>
                            </a>
                        </div>
                        <div class="col-md-3">
                            <button class="btn btn-outline-primary w-100" onclick="exportSubmissions()">
                                <i class="fas fa-download"></i>
                                <div>Export Results</div>
                                <small>Download CSV/Excel</small>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Grading Modal (Quick Grade) -->
<div class="modal fade" id="quickGradeModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Quick Grade</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="quickGradeContent">
                <!-- Quick grading content will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="saveQuickGrade">Save Grade</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    $(document).ready(function () {
        // Auto-submit filter form when select values change
        $('.form-select').change(function () {
            $('#filterForm').submit();
        });

        // Initialize tooltips
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
        
        // Ensure dropdowns don't get cut off
        $('.dropdown-toggle').on('show.bs.dropdown', function () {
            var dropdown = $(this).parent();
            var menu = dropdown.find('.dropdown-menu');
            
            // Position dropdown menu properly
            setTimeout(function() {
                var rect = dropdown[0].getBoundingClientRect();
                var spaceBelow = window.innerHeight - rect.bottom;
                var spaceAbove = rect.top;
                
                if (spaceBelow < 200 && spaceAbove > spaceBelow) {
                    menu.addClass('dropup');
                }
            }, 0);
        });
    });

    // Function to download individual attempt report
    function downloadAttemptReport(attemptId) {
        window.open(`/exams/attempt/${attemptId}/report/`, '_blank');
    }

    // Function to export all submissions
    function exportSubmissions() {
        var filters = new URLSearchParams(window.location.search);
        var exportUrl = '/exams/submissions/export/?' + filters.toString();
        window.open(exportUrl, '_blank');
    }

    // Function for quick grading (modal)
    function quickGrade(attemptId) {
        $('#quickGradeModal').modal('show');

        // Load grading form via AJAX
        $.get(`/exams/attempt/${attemptId}/quick-grade/`, function (data) {
            $('#quickGradeContent').html(data);
        });
    }

    // Bulk actions
    function bulkAction(action) {
        var selectedAttempts = [];
        $('input[name="selected_attempts"]:checked').each(function () {
            selectedAttempts.push($(this).val());
        });

        if (selectedAttempts.length === 0) {
            alert('Please select at least one submission!');
            return;
        }

        if (action === 'export') {
            var ids = selectedAttempts.join(',');
            window.open(`/exams/submissions/export/?ids=${ids}`, '_blank');
        } else if (action === 'grade') {
            var ids = selectedAttempts.join(',');
            window.location.href = `/exams/bulk-grade/?ids=${ids}`;
        }
    }

    // Select all checkboxes
    function toggleSelectAll() {
        var selectAll = $('#selectAll').prop('checked');
        $('input[name="selected_attempts"]').prop('checked', selectAll);
    }
</script>
{% endblock %}