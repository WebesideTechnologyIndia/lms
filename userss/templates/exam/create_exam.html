{% extends 'base.html' %}

{% block title %}Create Exam - LMS Admin{% endblock %}

{% block content %}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h4 class="card-title">
                        <i class="fas fa-plus-circle text-primary"></i>
                        Create New Exam
                    </h4>
                    <p class="text-muted mb-0">Set up a new exam with timing, questions, and assignment options</p>
                </div>
                
                <div class="card-body">
                    <form method="post" id="examForm">
                        {% csrf_token %}
                        
                        <!-- Display form errors -->
                        {% if form.non_field_errors %}
                            <div class="alert alert-danger">
                                {{ form.non_field_errors }}
                            </div>
                        {% endif %}
                        
                        <!-- Basic Information -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h5 class="text-primary border-bottom pb-2">
                                    <i class="fas fa-info-circle"></i> Basic Information
                                </h5>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-8">
                                <label class="form-label">Exam Title *</label>
                                {{ form.title }}
                                {% if form.title.errors %}
                                    <div class="text-danger">{{ form.title.errors }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Exam Type *</label>
                                {{ form.exam_type }}
                                {% if form.exam_type.errors %}
                                    <div class="text-danger">{{ form.exam_type.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-12">
                                <label class="form-label">Description *</label>
                                {{ form.description }}
                                {% if form.description.errors %}
                                    <div class="text-danger">{{ form.description.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-12">
                                <label class="form-label">Instructions for Students</label>
                                {{ form.instructions }}
                            </div>
                        </div>
                        
                        <!-- Marks Configuration -->
                        <div class="row mb-4 mt-4">
                            <div class="col-12">
                                <h5 class="text-primary border-bottom pb-2">
                                    <i class="fas fa-medal"></i> Marks Configuration
                                </h5>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Total Marks *</label>
                                {{ form.total_marks }}
                                {% if form.total_marks.errors %}
                                    <div class="text-danger">{{ form.total_marks.errors }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Passing Marks *</label>
                                {{ form.passing_marks }}
                                {% if form.passing_marks.errors %}
                                    <div class="text-danger">{{ form.passing_marks.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- Timing Configuration -->
                        <div class="row mb-4 mt-4">
                            <div class="col-12">
                                <h5 class="text-primary border-bottom pb-2">
                                    <i class="fas fa-clock"></i> Timing Configuration
                                </h5>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Timing Type *</label>
                                {{ form.timing_type }}
                                <div class="form-text">Choose how time limits will be applied to this exam</div>
                            </div>
                        </div>
                        
                        <!-- Time Per Question Dropdown -->
                        <div class="row mb-3" id="per-question-timing" style="display: none;">
                            <div class="col-md-6">
                                <label class="form-label">Time Per Question *</label>
                                {{ form.time_per_question_minutes }}
                                <div class="form-text">Time limit for each individual question</div>
                                {% if form.time_per_question_minutes.errors %}
                                    <div class="text-danger mt-2">{{ form.time_per_question_minutes.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- Total Exam Time Dropdown -->
                        <div class="row mb-3" id="total-exam-timing" style="display: none;">
                            <div class="col-md-6">
                                <label class="form-label">Total Exam Time *</label>
                                {{ form.total_exam_time_minutes }}
                                <div class="form-text">Total time limit for the entire exam</div>
                                {% if form.total_exam_time_minutes.errors %}
                                    <div class="text-danger mt-2">{{ form.total_exam_time_minutes.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- Exam Settings -->
                        <div class="row mb-4 mt-4">
                            <div class="col-12">
                                <h5 class="text-primary border-bottom pb-2">
                                    <i class="fas fa-cog"></i> Exam Settings
                                </h5>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <div class="form-check">
                                    {{ form.allow_retake }}
                                    <label class="form-check-label" for="{{ form.allow_retake.id_for_label }}">
                                        Allow Retake
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check">
                                    {{ form.show_results_immediately }}
                                    <label class="form-check-label" for="{{ form.show_results_immediately.id_for_label }}">
                                        Show Results Immediately
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check">
                                    {{ form.randomize_questions }}
                                    <label class="form-check-label" for="{{ form.randomize_questions.id_for_label }}">
                                        Randomize Questions
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Max Attempts</label>
                                {{ form.max_attempts }}
                            </div>
                            <div class="col-md-6" id="mcq-options" style="display: none;">
                                <div class="form-check mt-4">
                                    {{ form.randomize_options }}
                                    <label class="form-check-label" for="{{ form.randomize_options.id_for_label }}">
                                        Randomize MCQ Options
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Schedule -->
                        <div class="row mb-4 mt-4">
                            <div class="col-12">
                                <h5 class="text-primary border-bottom pb-2">
                                    <i class="fas fa-calendar"></i> Schedule (Optional)
                                </h5>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Start Date & Time</label>
                                {{ form.start_datetime }}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">End Date & Time</label>
                                {{ form.end_datetime }}
                            </div>
                        </div>
                        
                        <!-- Status -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Status</label>
                                {{ form.status }}
                            </div>
                        </div>
                        
                        <!-- Action Buttons -->
                        <div class="row mt-4">
                            <div class="col-12">
                                <div class="d-flex gap-2">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-save"></i> Create Exam
                                    </button>
                                    <a href="{% url 'exam_dashboard' %}" class="btn btn-secondary">
                                        <i class="fas fa-times"></i> Cancel
                                    </a>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function () {

    // ELEMENTS
    const timingTypeSelect = document.getElementById('id_timing_type');
    const examTypeSelect = document.getElementById('id_exam_type');
    const perQuestionDiv = document.getElementById('per-question-timing');
    const totalExamDiv = document.getElementById('total-exam-timing');
    const mcqOptionsDiv = document.getElementById('mcq-options');
    const examForm = document.getElementById('examForm');

    const timePerQuestionField = document.getElementById('id_time_per_question_minutes');
    const totalExamTimeField = document.getElementById('id_total_exam_time_minutes');
    const totalMarksField = document.getElementById('id_total_marks');
    const passingMarksField = document.getElementById('id_passing_marks');
    const startDateField = document.getElementById('id_start_datetime');
    const endDateField = document.getElementById('id_end_datetime');

    // SAFETY: If form does not exist, stop script
    if (!examForm) return;

    // ------------------------------
    // TIMING FIELD VISIBILITY
    // ------------------------------
    function updateTimingFields() {
        const timingType = timingTypeSelect?.value;

        // Hide all timing sections by default
        perQuestionDiv.style.display = 'none';
        totalExamDiv.style.display = 'none';

        // Show relevant section based on timing type
        if (timingType === 'per_question') {
            perQuestionDiv.style.display = 'block';
        } 
        else if (timingType === 'total_exam') {
            totalExamDiv.style.display = 'block';
        }
        // 'no_timing' shows nothing - that's what you want!
    }

    // ------------------------------
    // EXAM TYPE FIELDS (MCQ)
    // ------------------------------
    function updateExamTypeFields() {
        const examType = examTypeSelect?.value;
        mcqOptionsDiv.style.display = (examType === 'mcq') ? 'block' : 'none';
    }

    // ------------------------------
    // EVENT LISTENERS
    // ------------------------------
    if (timingTypeSelect) {
        timingTypeSelect.addEventListener('change', updateTimingFields);
    }

    if (examTypeSelect) {
        examTypeSelect.addEventListener('change', updateExamTypeFields);
    }

    // ------------------------------
    // FORM VALIDATION
    // ------------------------------
    examForm.addEventListener('submit', function (e) {
        const timingType = timingTypeSelect.value;
        const totalMarks = parseInt(totalMarksField.value || 0);
        const passingMarks = parseInt(passingMarksField.value || 0);

        // --- PASSING MARKS VALIDATION ---
        if (passingMarks > totalMarks) {
            alert("Passing marks cannot be greater than total marks!");
            e.preventDefault();
            return false;
        }

        // --- DATE VALIDATION ---
        const start = new Date(startDateField.value);
        const end = new Date(endDateField.value);

        if (startDateField.value && endDateField.value && start >= end) {
            alert("End date must be after start date!");
            e.preventDefault();
            return false;
        }

        // --- TIMING VALIDATION ---
        if (timingType === "per_question") {
            if (!timePerQuestionField.value || timePerQuestionField.value === "") {
                alert("Please select time per question!");
                e.preventDefault();
                return false;
            }
        }

        if (timingType === "total_exam") {
            if (!totalExamTimeField.value || totalExamTimeField.value === "") {
                alert("Please select total exam time!");
                e.preventDefault();
                return false;
            }
        }

        return true;
    });

    // ------------------------------
    // INIT
    // ------------------------------
    updateTimingFields();
    updateExamTypeFields();
});
</script>
{% endblock %}