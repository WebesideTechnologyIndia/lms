{% extends 'base.html' %}
{% load static %}

{% block title %}View Exam Attempt - {{ attempt.exam.title }}{% endblock %}

{% block content %}
<div class="container-fluid px-4 py-4">
    
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-1">üìù Exam Attempt Details</h2>
            <p class="text-muted mb-0">{{ attempt.exam.title }}</p>
        </div>
       
    </div>

    <!-- Student & Attempt Info Card -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="fas fa-user"></i> Student Information</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-3">
                    <p class="mb-2"><strong>Student:</strong></p>
                    <p class="text-muted">{{ attempt.student.get_full_name }}</p>
                </div>
                <div class="col-md-3">
                    <p class="mb-2"><strong>Attempt Number:</strong></p>
                    <p class="text-muted">Attempt {{ attempt.attempt_number }}</p>
                </div>
                <div class="col-md-3">
                    <p class="mb-2"><strong>Status:</strong></p>
                    <span class="badge 
                        {% if attempt.status == 'submitted' %}bg-success
                        {% elif attempt.status == 'auto_submitted' %}bg-warning
                        {% elif attempt.status == 'in_progress' %}bg-info
                        {% else %}bg-secondary{% endif %}">
                        {{ attempt.get_status_display }}
                    </span>
                </div>
                <div class="col-md-3">
                    <p class="mb-2"><strong>Submitted At:</strong></p>
                    <p class="text-muted">
                        {% if attempt.submitted_at %}
                            {{ attempt.submitted_at|date:"d M Y, h:i A" }}
                        {% else %}
                            Not submitted
                        {% endif %}
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Score Card -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-info text-white">
            <h5 class="mb-0"><i class="fas fa-chart-bar"></i> Score & Performance</h5>
        </div>
        <div class="card-body">
            <div class="row text-center">
                <div class="col-md-3">
                    <h4 class="mb-1 text-primary">{{ attempt.total_marks_obtained }}/{{ attempt.exam.total_marks }}</h4>
                    <p class="text-muted mb-0">Marks Obtained</p>
                </div>
                <div class="col-md-3">
                    <h4 class="mb-1 text-info">{{ attempt.percentage|floatformat:1 }}%</h4>
                    <p class="text-muted mb-0">Percentage</p>
                </div>
                <div class="col-md-3">
                    <h4 class="mb-1 
                        {% if attempt.is_passed %}text-success
                        {% else %}text-danger{% endif %}">
                        {% if attempt.is_passed %}
                            <i class="fas fa-check-circle"></i> PASSED
                        {% else %}
                            <i class="fas fa-times-circle"></i> FAILED
                        {% endif %}
                    </h4>
                    <p class="text-muted mb-0">Result</p>
                </div>
                <div class="col-md-3">
                    <h4 class="mb-1 text-secondary">{{ attempt.time_spent_minutes }} min</h4>
                    <p class="text-muted mb-0">Time Spent</p>
                </div>
            </div>
        </div>
    </div>

    <!-- MCQ Responses -->
    {% if attempt.exam.exam_type == 'mcq' %}
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-dark text-white">
            <h5 class="mb-0"><i class="fas fa-list-check"></i> MCQ Responses</h5>
        </div>
        <div class="card-body">
            {% if mcq_responses %}
                {% for response in mcq_responses %}
                <div class="card mb-3 border-left-{% if response.is_correct %}success{% else %}danger{% endif %}" style="border-left: 4px solid;">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <h6 class="mb-0">
                                <span class="badge bg-secondary me-2">Q{{ response.question.order }}</span>
                                {{ response.question.question_text }}
                            </h6>
                            <span class="badge 
                                {% if response.is_correct %}bg-success
                                {% else %}bg-danger{% endif %}">
                                {% if response.is_correct %}
                                    <i class="fas fa-check"></i> Correct
                                {% else %}
                                    <i class="fas fa-times"></i> Wrong
                                {% endif %}
                            </span>
                        </div>

                        {% if response.question.question_image %}
                        <div class="mb-3">
                            <img src="{{ response.question.question_image.url }}" 
                                 alt="Question Image" 
                                 class="img-fluid rounded" 
                                 style="max-height: 300px;">
                        </div>
                        {% endif %}

                        <div class="options-list">
                            <p class="mb-2"><strong>Options:</strong></p>
                            {% for option in response.question.options.all %}
                            <div class="form-check mb-2 p-3 rounded
                                {% if option == response.selected_option %}bg-light border border-primary
                                {% elif option.is_correct %}bg-success bg-opacity-10 border border-success
                                {% endif %}">
                                <input class="form-check-input" 
                                       type="radio" 
                                       disabled
                                       {% if option == response.selected_option %}checked{% endif %}>
                                <label class="form-check-label">
                                    {{ option.option_text }}
                                    {% if option.is_correct %}
                                        <span class="badge bg-success ms-2">‚úì Correct Answer</span>
                                    {% endif %}
                                    {% if option == response.selected_option and not option.is_correct %}
                                        <span class="badge bg-danger ms-2">‚úó Your Answer</span>
                                    {% endif %}
                                </label>
                            </div>
                            {% endfor %}
                        </div>

                        {% if response.question.explanation %}
                        <div class="alert alert-info mt-3 mb-0">
                            <strong><i class="fas fa-lightbulb"></i> Explanation:</strong><br>
                            {{ response.question.explanation }}
                        </div>
                        {% endif %}

                        <div class="mt-3 text-muted">
                            <small>
                                <i class="fas fa-clock"></i> 
                                Time spent: {{ response.time_spent_seconds }} seconds | 
                                Marks: {{ response.question.marks }}
                            </small>
                        </div>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <p class="text-muted text-center">No responses found.</p>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <!-- Q&A Responses -->
    {% if attempt.exam.exam_type == 'qa' %}
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-dark text-white">
            <h5 class="mb-0"><i class="fas fa-pen"></i> Q&A Responses</h5>
        </div>
        <div class="card-body">
            {% if qa_responses %}
                {% for response in qa_responses %}
                <div class="card mb-3">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <h6 class="mb-0">
                                <span class="badge bg-secondary me-2">Q{{ response.question.order }}</span>
                                {{ response.question.question_text }}
                            </h6>
                            <span class="badge bg-info">{{ response.question.marks }} marks</span>
                        </div>

                        {% if response.question.question_image %}
                        <div class="mb-3">
                            <img src="{{ response.question.question_image.url }}" 
                                 alt="Question Image" 
                                 class="img-fluid rounded" 
                                 style="max-height: 300px;">
                        </div>
                        {% endif %}

                        <div class="mb-3">
                            <p class="mb-2"><strong>Student's Answer:</strong></p>
                            <div class="p-3 bg-light rounded">
                                {{ response.answer_text|linebreaks }}
                            </div>
                        </div>

                        {% if response.question.model_answer %}
                        <div class="mb-3">
                            <p class="mb-2"><strong>Model Answer:</strong></p>
                            <div class="p-3 bg-info bg-opacity-10 rounded border border-info">
                                {{ response.question.model_answer|linebreaks }}
                            </div>
                        </div>
                        {% endif %}

                        {% if response.is_graded %}
                        <div class="alert alert-success">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <strong><i class="fas fa-check-circle"></i> Graded</strong>
                                <span class="badge bg-success fs-6">
                                    {{ response.marks_obtained }}/{{ response.question.marks }} marks
                                </span>
                            </div>
                            {% if response.feedback %}
                            <hr>
                            <p class="mb-1"><strong>Feedback:</strong></p>
                            <p class="mb-0">{{ response.feedback|linebreaks }}</p>
                            {% endif %}
                            <div class="mt-2 text-muted">
                                <small>
                                    Graded by: {{ response.graded_by.get_full_name }} | 
                                    {{ response.graded_at|date:"d M Y, h:i A" }}
                                </small>
                            </div>
                        </div>
                        {% else %}
                        <div class="alert alert-warning mb-0">
                            <i class="fas fa-hourglass-half"></i> Not graded yet
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <p class="text-muted text-center">No responses found.</p>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <!-- Assignment Submission -->
    {% if attempt.exam.exam_type == 'assignment' %}
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-dark text-white">
            <h5 class="mb-0"><i class="fas fa-file-upload"></i> Assignment Submission</h5>
        </div>
        <div class="card-body">
            {% if assignment_submission %}
                {% if assignment_submission.submission_text %}
                <div class="mb-4">
                    <h6><strong>Submission Text:</strong></h6>
                    <div class="p-3 bg-light rounded">
                        {{ assignment_submission.submission_text|linebreaks }}
                    </div>
                </div>
                {% endif %}

                {% if assignment_submission.uploaded_files %}
                <div class="mb-4">
                    <h6><strong>Uploaded Files:</strong></h6>
                    <div class="list-group">
                        {% for file in assignment_submission.uploaded_files %}
                        <a href="{{ file }}" 
                           target="_blank" 
                           class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                            <span><i class="fas fa-file-pdf text-danger"></i> {{ file|slice:"-50:" }}</span>
                            <span class="badge bg-primary rounded-pill">Download</span>
                        </a>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                {% if assignment_submission.is_graded %}
                <div class="alert alert-success">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <strong><i class="fas fa-check-circle"></i> Graded</strong>
                        <span class="badge bg-success fs-6">
                            {{ assignment_submission.marks_obtained }}/{{ attempt.exam.total_marks }} marks
                        </span>
                    </div>
                    {% if assignment_submission.feedback %}
                    <hr>
                    <p class="mb-1"><strong>Feedback:</strong></p>
                    <p class="mb-0">{{ assignment_submission.feedback|linebreaks }}</p>
                    {% endif %}
                    <div class="mt-2 text-muted">
                        <small>
                            Graded by: {{ assignment_submission.graded_by.get_full_name }} | 
                            {{ assignment_submission.graded_at|date:"d M Y, h:i A" }}
                        </small>
                    </div>
                </div>
                {% else %}
                <div class="alert alert-warning">
                    <i class="fas fa-hourglass-half"></i> Not graded yet
                </div>
                {% endif %}
            {% else %}
                <p class="text-muted text-center">No submission found.</p>
            {% endif %}
        </div>
    </div>
    {% endif %}

</div>

<style>
.border-left-success {
    border-left-color: #28a745 !important;
}

.border-left-danger {
    border-left-color: #dc3545 !important;
}
</style>
{% endblock %}