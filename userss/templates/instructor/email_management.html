<!-- templates/instructor/email_management.html -->
{% extends 'instructor_base.html' %}
{% load static %}

{% block title %}Email Management - Instructor Panel{% endblock %}

{% block extra_css %}
<style>
.page-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 20px;
    border-radius: 15px;
    margin-bottom: 30px;
}

.email-stats {
    background: #f8f9fa;
    border-left: 4px solid #007bff;
    padding: 15px;
    margin-bottom: 20px;
}

.template-preview {
    background: #f8f9fa;
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 15px;
    margin-top: 15px;
    display: none;
}

.student-list {
    max-height: 300px;
    overflow-y: auto;
    border: 1px solid #ddd;
    border-radius: 5px;
    padding: 10px;
    margin-top: 15px;
    display: none;
}

.student-item {
    padding: 8px;
    border-bottom: 1px solid #eee;
    cursor: pointer;
}

.student-item:hover {
    background-color: #f0f0f0;
}

.student-item:last-child {
    border-bottom: none;
}

.email-form {
    background: white;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    padding: 25px;
}

.form-section {
    margin-bottom: 25px;
    padding-bottom: 20px;
    border-bottom: 1px solid #eee;
}

.form-section:last-child {
    border-bottom: none;
}

.custom-content {
    display: none;
}

.btn-send {
    background: linear-gradient(45deg, #28a745, #20c997);
    border: none;
    padding: 12px 30px;
    font-weight: 600;
}

.btn-send:hover {
    background: linear-gradient(45deg, #218838, #1ca085);
}

.recent-email-item {
    padding: 10px;
    border-left: 3px solid transparent;
    margin-bottom: 10px;
    background: #f8f9fa;
    border-radius: 5px;
}

.recent-email-item.success {
    border-left-color: #28a745;
}

.recent-email-item.failed {
    border-left-color: #dc3545;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="page-header">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h2 class="mb-1">Email Management</h2>
                <p class="mb-0 opacity-75">Send emails to your batch students</p>
            </div>
            <div>
                <a href="{% url 'instructor_email_history' %}" class="btn btn-light">
                    <i class="bi bi-clock-history me-2"></i>Email History
                </a>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Main Email Form -->
        <div class="col-lg-8">
            <div class="email-form">
                <h4 class="mb-4">
                    <i class="bi bi-envelope me-2"></i>Send Email to Students
                </h4>

                <!-- Email Limit Info -->
                {% if email_limit_setting %}
                <div class="email-stats">
                    <div class="row">
                        <div class="col-md-3">
                            <strong>Daily Limit:</strong><br>
                            <span class="fs-5">{{ email_limit_setting.email_limit_per_day }}</span>
                        </div>
                        <div class="col-md-3">
                            <strong>Used Today:</strong><br>
                            <span class="fs-5">{{ today_summary.total_emails_sent|default:0 }}</span>
                        </div>
                        <div class="col-md-3">
                            <strong>Remaining:</strong><br>
                            <span class="fs-5 text-success">{{ remaining_emails }}</span>
                        </div>
                        <div class="col-md-3">
                            <strong>Success Rate:</strong><br>
                            <span class="fs-5">
                                {% if today_summary.total_emails_sent > 0 %}
                                    {% widthratio today_summary.successful_emails today_summary.total_emails_sent 100 %}%
                                {% else %}
                                    0%
                                {% endif %}
                            </span>
                        </div>
                    </div>
                </div>
                {% endif %}

                <form method="post" action="{% url 'instructor_send_batch_email' %}">
                    {% csrf_token %}

                    <!-- Step 1: Select Batch -->
                    <div class="form-section">
                        <h5><i class="bi bi-1-circle me-2"></i>Select Batch</h5>
                        <div class="row">
                            <div class="col-md-8">
                                <select name="batch_id" id="batchSelect" class="form-select" required>
                                    <option value="">Choose a batch...</option>
                                    {% for batch in instructor_batches %}
                                    <option value="{{ batch.id }}" data-course="{{ batch.course.title }}">
                                        {{ batch.name }} - {{ batch.course.title }}
                                        ({{ batch.get_enrolled_count }} students)
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-4">
                                <button type="button" class="btn btn-outline-primary" id="loadStudentsBtn" disabled>
                                    <i class="bi bi-people me-2"></i>Load Students
                                </button>
                            </div>
                        </div>

                        <!-- Students List -->
                        <div id="studentsContainer" class="student-list">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6 class="mb-0">Select Students:</h6>
                                <div>
                                    <button type="button" class="btn btn-sm btn-outline-primary" id="selectAllStudents">
                                        Select All
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-secondary" id="clearAllStudents">
                                        Clear All
                                    </button>
                                </div>
                            </div>
                            <div id="studentsList">
                                <!-- Students will be loaded here -->
                            </div>
                        </div>
                    </div>

                    <!-- Step 2: Select Template or Custom Content -->
                    <div class="form-section">
                        <h5><i class="bi bi-2-circle me-2"></i>Email Content</h5>
                        
                        <!-- Template Selection -->
                        <div class="mb-3">
                            <label class="form-label">Email Template (Optional)</label>
                            <select name="template_id" id="templateSelect" class="form-select">
                                <option value="">Select a template or write custom email...</option>
                                {% for template in email_templates %}
                                <option value="{{ template.id }}" data-type="{{ template.template_type.name }}">
                                    {{ template.name }} ({{ template.template_type.name }})
                                </option>
                                {% endfor %}
                            </select>
                        </div>

                        <!-- Template Preview -->
                        <div id="templatePreview" class="template-preview">
                            <h6>Template Preview:</h6>
                            <div id="previewContent">
                                <!-- Preview will be loaded here -->
                            </div>
                        </div>

                        <!-- Custom Content (shown when no template selected) -->
                        <div id="customContent" class="custom-content">
                            <div class="mb-3">
                                <label for="customSubject" class="form-label">Email Subject</label>
                                <input type="text" name="custom_subject" id="customSubject" 
                                       class="form-control" placeholder="Enter email subject">
                            </div>
                            <div class="mb-3">
                                <label for="customMessage" class="form-label">Email Message</label>
                                <textarea name="custom_message" id="customMessage" class="form-control" 
                                          rows="8" placeholder="Write your email message here...

Available variables:
{{username}} - Student's username
{{first_name}} - Student's first name  
{{last_name}} - Student's last name
{{email}} - Student's email
{{batch_name}} - Batch name
{{course_name}} - Course name
{{instructor_name}} - Your name"></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Send Button -->
                    <div class="text-center">
                        <button type="submit" class="btn btn-success btn-send btn-lg" id="sendEmailBtn" disabled>
                            <i class="bi bi-send me-2"></i>Send Email
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Quick Stats -->
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="mb-0"><i class="bi bi-graph-up me-2"></i>Quick Stats</h6>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-6">
                            <div class="border-end">
                                <h4 class="text-primary">{{ instructor_batches.count }}</h4>
                                <small class="text-muted">Active Batches</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <h4 class="text-info">
                                {% if instructor_batches %}
                                    {% for batch in instructor_batches %}
                                        {% if forloop.first %}{{ batch.get_enrolled_count }}{% endif %}
                                        {% if not forloop.first %}+{{ batch.get_enrolled_count }}{% endif %}
                                    {% endfor %}
                                {% else %}
                                    0
                                {% endif %}
                            </h4>
                            <small class="text-muted">Total Students</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Emails -->
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0"><i class="bi bi-clock-history me-2"></i>Recent Emails</h6>
                </div>
                <div class="card-body">
                    {% if recent_emails %}
                        {% for email in recent_emails %}
                        <div class="recent-email-item {% if email.is_sent_successfully %}success{% else %}failed{% endif %}">
                            <div class="d-flex justify-content-between">
                                <strong>{{ email.subject|truncatechars:30 }}</strong>
                                <small class="text-muted">{{ email.sent_time|date:"M d" }}</small>
                            </div>
                            <small class="text-muted">
                                To: {{ email.recipient_email }}
                                {% if email.is_sent_successfully %}
                                    <span class="badge bg-success ms-2">Sent</span>
                                {% else %}
                                    <span class="badge bg-danger ms-2">Failed</span>
                                {% endif %}
                            </small>
                        </div>
                        {% endfor %}
                        <div class="text-center mt-3">
                            <a href="{% url 'instructor_email_history' %}" class="btn btn-sm btn-outline-primary">
                                View All History
                            </a>
                        </div>
                    {% else %}
                        <p class="text-muted text-center">No emails sent yet.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const batchSelect = document.getElementById('batchSelect');
    const loadStudentsBtn = document.getElementById('loadStudentsBtn');
    const studentsContainer = document.getElementById('studentsContainer');
    const studentsList = document.getElementById('studentsList');
    const templateSelect = document.getElementById('templateSelect');
    const templatePreview = document.getElementById('templatePreview');
    const customContent = document.getElementById('customContent');
    const sendEmailBtn = document.getElementById('sendEmailBtn');
    
    // Enable/disable load students button
    batchSelect.addEventListener('change', function() {
        if (this.value) {
            loadStudentsBtn.disabled = false;
        } else {
            loadStudentsBtn.disabled = true;
            studentsContainer.style.display = 'none';
            checkFormValid();
        }
    });
    
    // Load students for selected batch
    loadStudentsBtn.addEventListener('click', function() {
        const batchId = batchSelect.value;
        if (!batchId) return;
        
        this.disabled = true;
        this.innerHTML = '<i class="spinner-border spinner-border-sm me-2"></i>Loading...';
        
        fetch(`/instructor/batch/${batchId}/students/`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayStudents(data.students);
                    studentsContainer.style.display = 'block';
                } else {
                    alert(data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error loading students');
            })
            .finally(() => {
                this.disabled = false;
                this.innerHTML = '<i class="bi bi-people me-2"></i>Load Students';
                checkFormValid();
            });
    });
    
    // Display students list
    function displayStudents(students) {
        studentsList.innerHTML = '';
        students.forEach(student => {
            const studentDiv = document.createElement('div');
            studentDiv.className = 'student-item';
            studentDiv.innerHTML = `
                <label class="form-check-label w-100">
                    <input type="checkbox" name="selected_students" value="${student.id}" class="form-check-input me-2">
                    <strong>${student.name}</strong><br>
                    <small class="text-muted">${student.email}</small>
                </label>
            `;
            studentsList.appendChild(studentDiv);
        });
        
        // Add event listeners for checkboxes
        const checkboxes = studentsList.querySelectorAll('input[type="checkbox"]');
        checkboxes.forEach(checkbox => {
            checkbox.addEventListener('change', checkFormValid);
        });
    }
    
    // Select/Clear all students
    document.getElementById('selectAllStudents').addEventListener('click', function() {
        const checkboxes = studentsList.querySelectorAll('input[type="checkbox"]');
        checkboxes.forEach(checkbox => checkbox.checked = true);
        checkFormValid();
    });
    
    document.getElementById('clearAllStudents').addEventListener('click', function() {
        const checkboxes = studentsList.querySelectorAll('input[type="checkbox"]');
        checkboxes.forEach(checkbox => checkbox.checked = false);
        checkFormValid();
    });
    
    // Template selection handling
    templateSelect.addEventListener('change', function() {
        const templateId = this.value;
        
        if (templateId) {
            // Load template preview
            fetch(`/instructor/email-template/${templateId}/preview/`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('previewContent').innerHTML = `
                            <div class="mb-2">
                                <strong>Subject:</strong> ${data.template.subject}
                            </div>
                            <div>
                                <strong>Message:</strong><br>
                                <div style="white-space: pre-wrap;">${data.template.body}</div>
                            </div>
                        `;
                        templatePreview.style.display = 'block';
                        customContent.style.display = 'none';
                        
                        // Clear custom content
                        document.getElementById('customSubject').value = '';
                        document.getElementById('customMessage').value = '';
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        } else {
            // Show custom content form
            templatePreview.style.display = 'none';
            customContent.style.display = 'block';
        }
        checkFormValid();
    });
    
    // Custom content validation
    document.getElementById('customSubject').addEventListener('input', checkFormValid);
    document.getElementById('customMessage').addEventListener('input', checkFormValid);
    
    // Form validation function
    function checkFormValid() {
        const batchSelected = batchSelect.value;
        const studentsSelected = studentsList.querySelectorAll('input[type="checkbox"]:checked').length > 0;
        const templateSelected = templateSelect.value;
        const customSubject = document.getElementById('customSubject').value.trim();
        const customMessage = document.getElementById('customMessage').value.trim();
        
        let contentValid = false;
        if (templateSelected) {
            contentValid = true;
        } else if (customSubject && customMessage) {
            contentValid = true;
        }
        
        const formValid = batchSelected && studentsSelected && contentValid;
        sendEmailBtn.disabled = !formValid;
        
        // Update button text based on validation
        if (formValid) {
            const selectedCount = studentsList.querySelectorAll('input[type="checkbox"]:checked').length;
            sendEmailBtn.innerHTML = `<i class="bi bi-send me-2"></i>Send Email to ${selectedCount} Student${selectedCount > 1 ? 's' : ''}`;
        } else {
            sendEmailBtn.innerHTML = '<i class="bi bi-send me-2"></i>Send Email';
        }
    }
    
    // Form submission confirmation
    document.querySelector('form').addEventListener('submit', function(e) {
        const selectedCount = studentsList.querySelectorAll('input[type="checkbox"]:checked').length;
        const batchName = batchSelect.options[batchSelect.selectedIndex].text;
        
        if (!confirm(`Are you sure you want to send email to ${selectedCount} student(s) in ${batchName}?`)) {
            e.preventDefault();
        }
    });
});
</script>
{% endblock %}